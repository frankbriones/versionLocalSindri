{% extends 'base/base.html' %}
{% load i18n %}
{% load static %}

{% block page_content %}
<style>
    .center {
        margin-left: auto;
        margin-right: auto;
        display: block;
    }

    .inputimage {
        position: absolute;
        top: 0px;
        left: 0px;
        right: 0px;
        bottom: 0px;
        /* width: 150px;
        height: 150px; */
        margin-bottom: auto;
        opacity: 0;
    }
    .img-circle {
        border-radius: 100%;
    }

    .caja {
        font-family: Century Gothic, CenturyGothic, AppleGothic, sans-serif;
        color: #000000;
        font-size: 25px;
        font-weight: 400;
        text-align: right;
        ;
        margin: 0 0 25px;
        overflow: hidden;
        padding: 10px;
        /* border-radius: 35px 0px 35px 0px; 
        -moz-border-radius: 35px 0px 35px 0px; 
        -webkit-border-radius: 35px 0px 35px 0px;  */
        border: 2px solid #5878ca;
    }
</style>
<div class="app-content content">
    <div class="content-overlay"></div>
    <div class="content-wrapper">
        <div class="content-header row">
            <div class="content-header-left col-12 mb-2 mt-1">
                <div class="row breadcrumbs-top">
                    <div class="col-12">
                        <h5 class="content-header-title float-left pr-1 mb-0">{% trans "Órdenes de trabajo" %}</h5>
                        <div class="breadcrumb-wrapper col-12">
                            <ol class="breadcrumb p-0 mb-0">
                                <li class="breadcrumb-item"><a href="{% url 'bases:home' %}"><i class="bx bx-home-alt"></i></a>
                                </li>
                                <li class="breadcrumb-item"><a href="{% url 'trn:ordenes_lista' %}">{% trans "Órdenes" %}</a>
                                </li>
                                <li class="breadcrumb-item active">{% trans "Lista" %}
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="content-body">
            <section>
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">{% trans "Detalles de órden # " %}{{ orden.secuencia }}</h4>
                                <a class="heading-elements-toggle">
                                    <i class='bx bx-dots-vertical font-medium-3'></i>
                                </a>
                                <div class="heading-elements">
                                    <ul class="list-inline mb-0">
                                        <li>
                                            <a {% if orden.id_orden %} href="{% url 'trn:comprobante_tmp' orden.id_orden %}" {% else %} href="{% url 'trn:comprobante_tmp' 0 %}" {% endif %} target="_blank" type="button" class="btn btn-icon rounded-circle btn-outline-primary mr-1 mb-1" aria-label="Close">
                                                <i class="bx bx-printer"></i>
                                            </a>
                                        </li>
                                        
                                        <li>
                                            <a data-action="expand" title='{% trans "Expandir" %}' class="btn btn-icon rounded-circle btn-outline-primary mr-1 mb-1">
                                                <i class="bx bx-fullscreen"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 col-12">
                                            {% if imagenes %}
                                            <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                                                <ol class="carousel-indicators">
                                                    {% for imagen in imagenes %}
                                                    <li data-target="#carousel-example-generic" data-slide-to="0"></li>
                                                    {% endfor %}
                                                </ol>
                                                <div class="carousel-inner" role="listbox">
                                                    {% for imagen in imagenes %}
                                                    <div class="carousel-item">
                                                        <img width="100%" class="img-fluid" src="{{ imagen.imagen.url }}" alt="First slide">
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <a class="carousel-control-prev" href="#carousel-example-generic" role="button" data-slide="prev">
                                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                    <span class="sr-only">Previous</span>
                                                </a>
                                                <a class="carousel-control-next" href="#carousel-example-generic" role="button" data-slide="next">
                                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                    <span class="sr-only">Next</span>
                                                </a>
                                            </div>
                                            {% else %}
                                            <div class="form-label-group">
                                                <img id="id_img_tmp" name="imagentmp" {% if item %} src="{{ item.imagen.url }}" {% else %} src="{% static 'base/img/icons/nofoto2.png' %}" style="width: 300px;" {% endif %} class="img-circle center img-fluid pointer" width="100%">
                                                <label for="city-column">{% trans "Imagen" %}</label>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-5 col-12">
                                            <div class="row">
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled {% if detalleSolicitud != None %} value="{{ detalleSolicitud.item.sku }}" {% elif detalle != None %} 
                                                        {% if detalle.pieza %}value="{{ detalle.pieza.sku }}"{% else %}value="{{detalle.id_item.sku}}"{% endif %} {% else %} value="{{ item.sku }}" {% endif %}>
                                                        <label for="first-name-column">{% trans "SKU" %}</label>
                                                    </div>
                                                </div>
                                                {% if user.is_superuser or user.tipo_usuario_id == 3 %}
                                                <div class="col-md-12 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.cliente }}">
                                                        <label for="first-name-column">{% trans "Cliente" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if not orden.externa %}
                                                <div class="col-md-12 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ item.taller }}">
                                                        <label for="first-name-column">{% trans "Taller" %}</label>
                                                    </div>
                                                </div>
                                                {% else %}
                                                <div class="col-md-12 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ item.proveedor }}">
                                                        <label for="first-name-column">{% trans "Proveedor" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if user.tipo_usuario_id == 2 or user.tipo_usuario_id == 1 %}
                                                <div class="col-md-12 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.tienda.nombre }}">
                                                        <label for="first-name-column">{% trans "Solicita" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.origen_material }}">
                                                        <label for="first-name-column">{% trans "Origen material" %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.color.descripcion }}">
                                                        <label for="first-name-column">{% trans "Color solicitado" %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.estado }}">
                                                        <label for="first-name-column">{% trans "Estado" %}</label>
                                                    </div>
                                                </div>
                                                {% if detalleSolicitud %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ detalleSolicitud.item.descripcion }}">
                                                        <label for="first-name-column">{% trans "Ítem" %}</label>
                                                    </div>
                                                </div>
                                                {% else %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ item.descripcion }}">
                                                        <label for="first-name-column">{% trans "Ítem" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if detalleSolicitud %}
                                                <div class="col-md-12 col-12">
                                                    <div class="form-label-group">
                                                        <textarea name="txt_detalle" class="form-control" id="id_detalle" disabled>{{ item.detalle }}</textarea>
                                                        <!-- <input class="form-control" disabled value="{{ item.detalle }}"> -->
                                                        <label for="first-name-column">{% trans "Detalle" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if orden.datos_extra and orden.datos_extra != 'undefined' %}
                                                <div class="col-md-12 col-12">
                                                    <div class="form-label-group">
                                                        <textarea name="datos_extra" class="form-control" id="id_datos_extra" disabled>{{ orden.datos_extra }}</textarea>
                                                        <label for="first-name-column">{% trans "Detalle" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if orden.peso_solicitado %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.peso_solicitado }} gr">
                                                        <label for="first-name-column">{% trans "Peso solicitado" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if orden.peso_cliente_dividido %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.peso_cliente_dividido }} gr">
                                                        <label for="first-name-column">{% trans "Peso Cliente" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                               <!--  {% if orden.peso_materia_dividida %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.peso_materia_dividida }} gr">
                                                        <label for="first-name-column">{% trans "Peso Trabajado" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %} -->
                                                {% if user.tipo_usuario_id == 3 %}
                                                {% if orden.precio_final_venta %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input type="text" id="id_precio_final" class="form-control" disabled>
                                                        <label for="first-name-column">{% trans "Precio" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% endif %}
                                                {% if user.tipo_usuario_id == 2 %}
                                                {% if orden.total_taller %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled {% if user.pais.decimales %} value="{{ orden.total_taller }}" {% else %} value="{{ orden.total_taller|floatformat:'0' }}" {% endif %}>
                                                        <label for="first-name-column">{% trans "Precio" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% endif %}
                                                {% if orden.peso_final %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.peso_final }} gr">
                                                        <label for="first-name-column">{% trans "Peso final" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if user.tipo_usuario_id == 3 %}
                                                {% if orden.precio_recalculado %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled {% if user.pais.decimales %} value="{{ user.pais.simbolo_moneda}} {{ orden.precio_recalculado }}" {% else %} value="{{ user.pais.simbolo_moneda}} {{ orden.precio_recalculado|floatformat:'0' }}" {% endif %}>
                                                        <label for="first-name-column">{% trans "Precio recalculado" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% endif %}
                                                {% if user.tipo_usuario_id == 2 %}
                                                {% if orden.total_taller_recalculado %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled {% if user.pais.decimales %} value="{{ orden.total_taller_recalculado }}" {% else %} value="{{ orden.total_taller_recalculado|floatformat:'0' }}" {% endif %}>
                                                        <label for="first-name-column">{% trans "Precio recalculado" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% endif %}

                                                {% if detalleSolicitud %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        {% if detalleSolicitud.item.unidad_medida.descripcion == 'TALLA' %}
                                                        <input class="form-control" disabled value="{{ item.talla }}">
                                                        <label for="first-name-column">{% trans "Talla" %}</label>
                                                        {% else %}
                                                        <input class="form-control" disabled value="{{ item.longitud }} {{ detalleSolicitud.item.unidad_medida.simbolo }}">
                                                        <label for="first-name-column">{% trans "Longitud" %}</label>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% else %}
                                                {% if not orden.categoria.categoria_alianzas %}

                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled {% if detalle.estandar %} value="{{ detalle.medida }} {{ detalle.estandar }}" {% else %} value="{{ detalle.medida }} {{ detalle.unidad_medida }}" {% endif %}>
                                                        <label for="first-name-column">{% trans "Talla/Longitud" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% endif %}
                                                {% if orden.gramos_enviados %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.gramos_enviados }} gr">
                                                        <label for="first-name-column">{% trans "Gramos enviados joyería" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if orden.gramos_recibidos %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ orden.gramos_recibidos }} gr">
                                                        <label for="first-name-column">{% trans "Gramos recibidos taller" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if item.acabado %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ item.acabado }}">
                                                        <label for="first-name-column">{% trans "Acabado" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if item.parte_interna %}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ item.parte_interna }}">
                                                        <label for="first-name-column">{% trans "Parte interna" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if not orden.categoria.categoria_alianzas %}

                                                    <div class="col-md-6 col-12">
                                                        <div class="form-label-group">
                                                            <input class="form-control" disabled {% if detalle %} value="{{ detalle.cantidad_piedras }}" {% else %} value="{{ item.cantidad_piedras }}" {% endif %}>
                                                            <label for="first-name-column">{% trans "Cantidad de piedras" %}</label>
                                                        </div>
                                                    </div>
                                                {%endif%}
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        {% if item.tiempo_entrega_min %}
                                                        <input class="form-control" disabled
                                                            value="{{ item.tiempo_entrega_min }}  días">
                                                        <label
                                                            for="email-id-column">{% trans "Tiempo entrega mínimo" %}</label>
                                                        {% else %}
                                                        <input class="form-control" disabled
                                                            value="{{ item.tiempo_ent_min }}  días">
                                                        <label
                                                            for="email-id-column">{% trans "Tiempo entrega mínimo" %}</label>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-6 col-12">
                                                    <div class="form-label-group">
                                                        {% if item.tiempo_entrega_max %}
                                                        <input class="form-control" disabled
                                                            value="{{ item.tiempo_entrega_max }}  días">
                                                        <label
                                                            for="email-id-column">{% trans "Tiempo entrega máximo" %}</label>
                                                        {% else %}
                                                        <input class="form-control" disabled
                                                            value="{{ item.tiempo_ent_max }}  días">
                                                        <label
                                                            for="email-id-column">{% trans "Tiempo entrega máximo" %}</label>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                
                                                {% if item.secuencia %}
                                                <div class="col-md-12 col-12">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ item.secuencia }}">
                                                        <label
                                                            for="email-id-column">{% trans "Solicitud" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if orden.obs_recepcion_prod %}
                                                <div class="col-md-12 col-12">
                                                    <div class="form-label-group">
                                                        <textarea class="form-control" disabled rows="2">{{ orden.obs_recepcion_prod }}</textarea>
                                                        <label
                                                            for="email-id-column">{% trans "Observación de devolución" %}</label>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% if categoria_alianzas %}
                                                <div class="col-md-6 col-12 ">
                                                    <div class="form-label-group">
                                                        <input class="form-control" disabled value="{{ talla_mujer }}">
                                                        <label for="first-name-column"><span >{% trans "Talla Mujer" %}</span></label>
                                                    </div>
                                                </div>
                                                    {% if inscripcion_mujer %}
                                                    <div class="col-md-6 col-12">
                                                        <div class="form-label-group">
                                                            <input class="form-control" disabled value="{{ inscripcion_mujer }}">
                                                            <label for="first-name-column"><span>{% trans "Inscripcion Mujer" %}</span></label>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    <div class="col-md-6 col-12">
                                                        <div class="form-label-group">
                                                            <input class="form-control" disabled value="{{ talla_hombre }}">
                                                            <label for="first-name-column " ><span">{% trans "Talla Hombre" %}</span></label>
                                                        </div>
                                                    </div>
                                                    {% if inscripcion_hombre %}

                                                    <div class="col-md-6 col-12">
                                                        <div class="form-label-group">
                                                            <input class="form-control" disabled value="{{ inscripcion_hombre }}">
                                                            <label for="first-name-column "><span">{% trans "Inscripcion Hombre" %}</span></label>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                            {% endif %}
                                            </div>
                                     
                                        </div>
                                        
                                        <div class="col-md-3 col-12 timline-card">
                                            <ul class="widget-timeline">
                                                <li class="timeline-items timeline-icon-success active">
                                                    <div class="row timeline-time"><p class="font-small-1">{{ orden.fecha_creacion|date:"d/m/y H:i" }}</p></div>
                                                    <h6 class="timeline-title"><p class="font-small-2 text-success"><span class="fonticon-wrap mr-1">
                                                            <i class="bx bxs-add-to-queue"></i>
                                                    </span>{% trans "Ingresada" %}</p></h6>
                                                </li>
                                                {% if orden.env_material %}
                                                <li id="li_mat_enviado" class="timeline-items timeline-icon-secondary active">
                                                    <div id="fec_mat_enviado" class="row timeline-time"><p class="font-small-1">{{ orden.fecha_envio_mat|date:"d/m/y H:i" }}</p></div>
                                                    <h6 class="timeline-title">
                                                        <p id="txt_mat_enviado" class="text-secondary font-small-2">
                                                            <span class="fonticon-wrap mr-1">
                                                            <i class="bx bx-truck"></i>
                                                            </span>{% trans "Mat. enviado" %}
                                                        </p>
                                                    </h6>
                                                </li>
                                                {% endif %}
                                                {% if not orden.estado_id == 18 %}
                                                {% if not orden.externa %}
                                                <li id="li_proceso" class="timeline-items timeline-icon-secondary active">
                                                    <div id="fec_proceso" class="row timeline-time"><p class="font-small-1">{{ orden.fecha_recibe_mat|date:"d/m/y H:i" }}</p></div>
                                                    <h6 class="timeline-title"><p id="txt_proceso" class="font-small-2 text-secondary"><span class="fonticon-wrap mr-1">
                                                            <i class="bx bx-time"></i>
                                                    </span>{% trans "En proceso" %}</p></h6>
                                                </li>
                                                <li id="li_trab_fin" class="timeline-items timeline-icon-secondary active">
                                                    <div id="fec_trab_fin" class="row timeline-time"><p class="font-small-1">{{ orden.fecha_fin_trabajo|date:"d/m/y H:i" }}</p></div>
                                                    <h6 class="timeline-title"><p id="txt_trab_finalizado" class="font-small-2 text-secondary"><span class="fonticon-wrap mr-1">
                                                            <i class="bx bxs-purchase-tag"></i>
                                                    </span>{% trans "Trab. fin" %}</p></h6>
                                                </li>
                                                <li id="li_prod_enviado" class="timeline-items timeline-icon-secondary active">
                                                    <div id="fec_prod_enviado" class="row timeline-time"><p class="font-small-1">{{ orden.fecha_envio_prod|date:"d/m/y H:i" }}</p></div>
                                                    <h6 class="timeline-title"><p id="txt_prod_enviado" class="font-small-2 text-secondary"><span class="fonticon-wrap mr-1">
                                                            <i class="bx bx-truck"></i>
                                                    </span>{% trans "Prod. enviado" %}</p></h6>
                                                </li>
                                                {% endif %}
                                                {% if not orden.estado_id == 11 %}
                                                <li id="li_prod_recibido" class="timeline-items timeline-icon-secondary active">
                                                    <div id="fec_prod_recibido" class="row timeline-time"><p class="font-small-1">{{ orden.fecha_recibe_prod|date:"d/m/y H:i" }}</p></div>
                                                    <h6 class="timeline-title"><p id="txt_prod_recibido" class="font-small-2 text-secondary"><span class="fonticon-wrap mr-1">
                                                            <i class="bx bxs-package"></i>
                                                    </span>{% trans "Prod. recibido" %}</p></h6>
                                                </li>
                                                <li id="li_finalizado" class="timeline-items timeline-icon-secondary active">
                                                    <div id="fec_finalizado" class="row timeline-time"><p class="font-small-1">{{ orden.fecha_venta|date:"d/m/y H:i" }}</p></div>
                                                    <h6 class="timeline-title"><p id="txt_finalizado" class="font-small-2 text-secondary"><span class="fonticon-wrap mr-1">
                                                            <i class="bx bxs-cart-alt"></i>
                                                    </span>{% trans "Finalizada" %}</p></h6>
                                                </li>
                                                {% endif %}
                                                {% endif %}
                                                {% if orden.estado_id == 18 %}
                                                <li class="timeline-items timeline-icon-danger active">
                                                    <div class="row timeline-time"><p class="font-small-1">{{ orden.fecha_anulacion|date:"d/m/y H:i" }}</p></div>
                                                    <h6 class="timeline-title"><p id="txt_anulado" class="font-small-2 text-danger"><span class="fonticon-wrap mr-1">
                                                            <i class="bx bx-trash"></i>
                                                    </span>{% trans "Anulada" %}</p></h6>
                                                </li>
                                                {% endif %}
                                                {% if orden.estado_id == 11 %}
                                                <li class="timeline-items timeline-icon-danger active">
                                                    <div class="row timeline-time"><p class="font-small-1">{{ orden.fecha_modificacion|date:"d/m/y H:i" }}</p></div>
                                                    <h6 class="timeline-title"><p id="txt_devuelto" class="font-small-2 text-danger"><span class="fonticon-wrap mr-1">
                                                            <i class="bx bx-rotate-left"></i>
                                                    </span>{% trans "Devuelta" %}</p></h6>
                                                </li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                       
                                    </div>

                                    {% if adicionales_lista %}
                                                                        
                                    <div class="row" id="id_adicionales">

                                        <div class="col-md-12 col-12">
                                            <div class="accordion collapse-icon accordion-icon-rotate" id="accordionWrapa_ads1">
                                                <div class="card collapse-header">
                                                    <div id="heading_ads" class="card-header" data-toggle="collapse" data-target="#accordion_ads1" aria-expanded="false" aria-controls="accordion_ads1" role="tablist">
                                                        <span class="collapse-title">
                                                            <i class="bx bx-ruler align-middle"></i>
                                                            <span class="align-middle">{% trans "Adicionales" %}</span>
                                                        </span>
                                                    </div>
                                                    <div id="accordion_ads1" role="tabpanel" data-parent="#accordionWrapa_ads1" aria-labelledby="heading_ads" class="collapse">
                                                        <!-- <div class="card-content">
                                                            <div class="card-body"> -->
                                                                <div class="row">
                                                                    <div class="col-md-12 col-12">
                                                                        <div class="table-responsive">
                                                                            <table  class="table table-striped table-hover">
                                                                                <thead>
                                                                                    <th>{% trans "Descripción" %}</th>
                                                                                    <th>{% trans "Precio" %}</th>
                                                                                    <th>{% trans "Cantidad" %}</th>
                                                                                    <th>Subtotal</th>
                                                                                </thead>
                                                                                <tbody>
                                                                                    {% for adicional in adicionales_lista %}
                                                                                    <tr>
                                                                                        <td>{{ adicional.adicional.descripcion }}</td>
                                                                                        {% if user.tipo_usuario.descripcion == 'USUARIO OPERACIONES' %}
                                                                                        <td>{% if user.pais.decimales %}{{ adicional.precio_adicional_op|floatformat:'2' }}{% else %}{{ adicional.precio_adicional_op|floatformat:'0' }}{% endif %}</td> 
                                                                                        <td >{{ adicional.cantidad_adicionales }}</td>
                                                                                        <td id="id_subtotal_adicional_piedrasicional">{% if user.pais.decimales %}{{ adicional.subtotal_adicional_op|floatformat:'2' }}{% else %}{{ adicional.subtotal_adicional_op|floatformat:'0' }}{% endif %}</td>
                                                                                        {% else %}
                                                                                        <td>{% if user.pais.decimales %}{{ adicional.precio_adicional_taller|floatformat:'2' }}{% else %}{{ adicional.precio_adicional_taller|floatformat:'0' }}{% endif %}</td> 
                                                                                        <td >{{ adicional.cantidad_adicionales }}</td>
                                                                                        <td id="id_subtotal_adicional_piedrasicional">{% if user.pais.decimales %}{{ adicional.subtotal_adicional_taller|floatformat:'2' }}{% else %}{{ adicional.subtotal_adicional_taller|floatformat:'0' }}{% endif %}</td>
                                                                                        {% endif %}
                                                                                    </tr>
                                                                                    {% endfor %}
                                                                                </tbody>

                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            <!-- </div>
                                                        </div> -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if rubros_listado %}
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <div class="accordion collapse-icon accordion-icon-rotate" id="accordionWrapa_ads2">
                                                <div class="card collapse-header">
                                                    <div id="heading_ads2" class="card-header" data-toggle="collapse" data-target="#accordion_ads2" aria-expanded="false" aria-controls="accordion_ads2" role="tablist">
                                                        <span class="collapse-title">
                                                            <i class="bx bx-dollar align-middle"></i>
                                                            <span class="align-middle">{% trans "Rubros asociados" %}</span>
                                                        </span>
                                                    </div>
                                                    
                                                    <div id="accordion_ads2" role="tabpanel" data-parent="#accordionWrapa_ads2" aria-labelledby="heading_ads2" class="collapse">
                                                        <!-- <div class="card-content">
                                                            <div class="card-body"> -->
                                                                <div class="row">
                                                                    <div class="col-md-12 col-12">
                                                                        <div class="table-responsive">
                                                                            <table  class="table table-striped table-hover">
                                                                                <thead>
                                                                                    <th>{% trans "Descripción" %}</th>
                                                                                    <th>{% trans "Precio" %}</th>
                                                                                   
                                                                                </thead>
                                                                                <tbody>
                                                                                    {% for rubro in rubros_listado %}
                                                                                    <tr>
                                                                                        <td>{{rubro.rubro.descripcion}}</td>
                                                                                        <td>{{rubro.valor}}</td>
                                                                                    </tr>
                                                                                    {% endfor %}
                                                                                </tbody>

                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            <!-- </div>
                                                        </div> -->
                                                    </div>
                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                  <!--   {% if piedras_lista %}
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <div class="accordion collapse-icon accordion-icon-rotate" id="accordionWrapa_ads">
                                                <div class="card collapse-header">
                                                    <div id="heading_ads" class="card-header" data-toggle="collapse" data-target="#accordion_ads" aria-expanded="false" aria-controls="accordion_ads" role="tablist">
                                                        <span class="collapse-title">
                                                            <i class="bx bx-diamond align-middle"></i>
                                                            <span class="align-middle">{% trans "Piedras preciosas" %}</span>
                                                        </span>
                                                    </div>
                                                    <div id="accordion_ads" role="tabpanel" data-parent="#accordionWrapa_ads" aria-labelledby="heading_ads" class="collapse">
                                                        
                                                                <div class="row">
                                                                    <div class="col-md-12 col-12">
                                                                        <div class="table-responsive">
                                                                            <table  class="table table-striped table-hover">
                                                                                <thead>
                                                                                    <th>{% trans "Descripción" %}</th>
                                                                                    <th>{% trans "Cantidad" %}</th>
                                                                                    <th>{% trans "Precio" %}</th>
                                                                                    <th>Subtotal</th>
                                                                                </thead>
                                                                                <tbody>
                                                                                    {% for piedra in piedras_lista %}
                                                                                    <tr>
                                                                                        <td>{{ piedra.piedra.descripcion }}</td>
                                                                                        <td>{{ piedra.cantidad_piedras }}</td>
                                                                                        {% if user.tipo_usuario.descripcion == 'USUARIO OPERACIONES' %}
                                                                                        <td>{% if user.pais.decimales %}{{ piedra.precio_piedra_op|floatformat:'2' }}{% else %}{{ piedra.precio_piedra_op|floatformat:'0' }}{% endif %}</td> 
                                                                                        <td>{% if user.pais.decimales %}{{ piedra.subtotal_piedras_op|floatformat:'2' }}{% else %}{{ piedra.subtotal_piedras_op|floatformat:'0' }}{% endif %}</td>
                                                                                        {% else %}
                                                                                        <td>{% if user.pais.decimales %}{{ piedra.precio_piedra_taller|floatformat:'2' }}{% else %}{{ piedra.precio_piedra_taller|floatformat:'0' }}{% endif %}</td> 
                                                                                        <td>{% if user.pais.decimales %}{{ piedra.subtotal_piedras_taller|floatformat:'2' }}{% else %}{{ piedra.subtotal_piedras_taller|floatformat:'0' }}{% endif %}</td>
                                                                                        {% endif %}
                                                                                    </tr>
                                                                                    {% endfor %}
                                                                                </tbody>

                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %} -->


                                    {% if imagenes_orden_terminada %}
                                    <section id="component-swiper-centered-slides">
                                        <div class="card bg-transparent shadow-none">
                                            <div class="card-header">
                                                <h4 class="card-title">{% trans "Imágenes trabajo finalizado" %}</h4>
                                            </div>
                                            <div class="card-content">
                                                <div class="card-body">
                                                    <div class="swiper-centered-slides swiper-container p-1">
                                                        <div class="swiper-wrapper">
                                                            {% for imagen in imagenes_orden_terminada %}
                                                            <div class="swiper-slide rounded swiper-shadow"> 
                                                                <img class="img-fluid" src="{{ imagen.imagen.url }}" alt="First slide" style="max-width: 150px;">
                                                                <!-- <i class="bx bxl-google font-large-1"></i>
                                                                <div class="swiper-text pt-md-1 pt-sm-50">Getting Started</div> -->
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                        <div class="swiper-button-next"></div>
                                                        <div class="swiper-button-prev"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </section>
                                    {% endif %}
                                    {%  if piedras_alianza or piedras_lista %}
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <div class="accordion collapse-icon accordion-icon-rotate" id="accordionWrapa_ads">
                                                <div class="card collapse-header">
                                                    <div id="heading_ads" class="card-header" data-toggle="collapse" data-target="#accordion_ads" aria-expanded="false" aria-controls="accordion_ads" role="tablist">
                                                        <span class="collapse-title">
                                                            <i class="bx bx-diamond align-middle"></i>
                                                            <span class="align-middle">{% trans "Piedras Preciosas" %}</span>
                                                        </span>
                                                    </div>
                                                    <div id="accordion_ads" role="tabpanel" data-parent="#accordionWrapa_ads" aria-labelledby="heading_ads" class="collapse">
                                                        <div class="card-content">
                                                            <div class="card-body">
                                                                <!-- <div class="row">
                                                                    <div class="col-md-12 col-12">
                                                                        <div class="table-responsive">
                                                                            <table  class="table table-striped table-hover">
                                                                                <thead>
                                                                                    <th>{% trans "SKU" %}</th>
                                                                                    <th>{% trans "DESCRIPCION" %}</th>
                                                                                    <th>{% trans "PUNTOS" %}</th>
                                                                                    <th>{% trans "CANTIDAD" %}</th>
                                                                                </thead>
                                                                                <tbody>
                                                                                    {% for piedra in piedras_alianza %}
                                                                                    <tr>
                                                                                        <td>{{ piedra.sku }}</td>
                                                                                        <td>{{ piedra.descripcion }}</td>
                                                                                        <td>{{piedra.puntos}}</td>
                                                                                        <td>{{piedra.cantidad}}</td>
                                                                                       

                                                                                    </tr>
                                                                                    {% endfor %}
                                                                                </tbody>

                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div> -->
                                                                <div class="row">
                                                                    <div class="col-md-12 col-12">
                                                                        <div class="table-responsive">
                                                                            <table  class="table table-striped table-hover">
                                                                                <thead>
                                                                                    <th>{% trans "Descripción" %}</th>
                                                                                    <th>{% trans "Cantidad" %}</th>
                                                                                    {% if orden.categoria.categoria_alianzas %}<th>Diseño</th>{% endif %}
                                                                                    <th>{% trans "Precio" %}</th>
                                                                                    <th>Subtotal</th>
                                                                                </thead>
                                                                                <tbody>
                                                                                    {% for piedra in piedras_lista %}
                                                                                    <tr>
                                                                                        <td>{{ piedra.piedra.descripcion }}</td>
                                                                                        <td>{{ piedra.cantidad_piedras }}</td>
                                                                                        {% if orden.categoria.categoria_alianzas %}<td>{{piedra.diseño}}</td>{% endif %}
                                                                                        {% if user.tipo_usuario.descripcion == 'USUARIO OPERACIONES' %}
                                                                                        <td>{% if user.pais.decimales %}{{ piedra.precio_piedra_op|floatformat:'2' }}{% else %}{{ piedra.precio_piedra_op|floatformat:'0' }}{% endif %}</td> 
                                                                                        <td>{% if user.pais.decimales %}{{ piedra.subtotal_piedras_op|floatformat:'2' }}{% else %}{{ piedra.subtotal_piedras_op|floatformat:'0' }}{% endif %}</td>
                                                                                        {% else %}
                                                                                        <td>{% if user.pais.decimales %}{{ piedra.precio_piedra_taller|floatformat:'2' }}{% else %}{{ piedra.precio_piedra_taller|floatformat:'0' }}{% endif %}</td> 
                                                                                        <td>{% if user.pais.decimales %}{{ piedra.subtotal_piedras_taller|floatformat:'2' }}{% else %}{{ piedra.subtotal_piedras_taller|floatformat:'0' }}{% endif %}</td>
                                                                                        {% endif %}
                                                                                    </tr>
                                                                                    {% endfor %}
                                                                                </tbody>

                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if perms.trn.ver_comp_envio_op or perms.trn.ver_comp_envio_ta or perms.trn.ver_factura %}
                                    <div class="row" id="id_documentos">
                                        <div class="col-md-12 col-12">
                                            <div class="accordion collapse-icon accordion-icon-rotate" id="accordionWrapa_doc">
                                                <div class="card collapse-header">
                                                    <div id="heading_doc" class="card-header" data-toggle="collapse" data-target="#accordion_doc" aria-expanded="false" aria-controls="accordion_doc" role="tablist">
                                                        <span class="collapse-title">
                                                            <i class="bx bx-ruler align-middle"></i>
                                                            <span class="align-middle">{% trans "Documentos" %}</span>
                                                        </span>
                                                    </div>
                                                    <div id="accordion_doc" role="tabpanel" data-parent="#accordionWrapa_doc" aria-labelledby="heading_doc" class="collapse">
                                                        <div class="card-content">
                                                            <div class="card-body">
                                                                <div class="row">
                                                                    {% if orden.anticipo_fabricacion and perms.trn.ver_anticipo %}
                                                                    <div class="col-md-3 col-6">
                                                                        <a target="_blank" href="{{ orden.anticipo_fabricacion.url }}">
                                                                            <div class="card border shadow-none mb-1 app-file-info">
                                                                                <div class="card-content">
                                                                                    <div class="app-file-content-logo card-img-top" style="align-content: center; text-align: center;">
                                                                                        <i class="bx bx-file" style="font-size: 30px;"></i>
                                                                                    </div>
                                                                                    <div class="card-body p-50">
                                                                                        <div class="app-file-details">
                                                                                            <div class="app-file-name font-size-small font-weight-bold">{% trans "Anticipo de fabricación" %}</div>
                                                                                            <div class="app-file-type font-size-small text-muted">{{ orden.fecha_creacion|date:"d/m/y H:i" }}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </a>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if orden.factura_taller and perms.trn.ver_factura_taller%}
                                                                    <div class="col-md-3 col-6">
                                                                        <a target="_blank" href="{{ orden.factura_taller.url }}">
                                                                            <div class="card border shadow-none mb-1 app-file-info">
                                                                                <div class="card-content">
                                                                                    <div class="app-file-content-logo card-img-top" style="align-content: center; text-align: center;">
                                                                                        <i class="bx bx-file" style="font-size: 30px;"></i>
                                                                                    </div>
                                                                                    <div class="card-body p-50">
                                                                                        <div class="app-file-details">
                                                                                            <div class="app-file-name font-size-small font-weight-bold">{% trans "Factura taller" %}</div>
                                                                                            <div class="app-file-type font-size-small text-muted">{{ orden.fecha_recibe_prod|date:"d/m/y H:i" }}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </a>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if orden.comp_envio_op and perms.trn.ver_comp_envio_op %}
                                                                    <div class="col-md-3 col-6">
                                                                        <a target="_blank" href="{{ orden.comp_envio_op.url }}">
                                                                            <div class="card border shadow-none mb-1 app-file-info">
                                                                                <div class="card-content">
                                                                                    <div class="app-file-content-logo card-img-top" style="align-content: center; text-align: center;">
                                                                                        <i class="bx bx-file" style="font-size: 30px;"></i>
                                                                                    </div>
                                                                                    <div class="card-body p-50">
                                                                                        <div class="app-file-details">
                                                                                            <div class="app-file-name font-size-small font-weight-bold">{% trans "Comprobante de envío de material" %}</div>
                                                                                            <div class="app-file-type font-size-small text-muted">{{ orden.fecha_envio_mat|date:"d/m/y H:i" }}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </a>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if orden.comp_envio_ta and perms.trn.ver_comp_envio_ta %}
                                                                    <div class="col-md-3 col-6">
                                                                        <a target="_blank" href="{{ orden.comp_envio_ta.url }}">
                                                                            <div class="card border shadow-none mb-1 app-file-info">
                                                                                <div class="card-content">
                                                                                    <div class="app-file-content-logo card-img-top" style="align-content: center; text-align: center;">
                                                                                        <i class="bx bx-file" style="font-size: 30px;"></i>
                                                                                    </div>
                                                                                    <div class="card-body p-50">
                                                                                        <div class="app-file-details">
                                                                                            <div class="app-file-name font-size-small font-weight-bold">{% trans "Comprobante de envío de producto" %}</div>
                                                                                            <div class="app-file-type font-size-small text-muted">{{ orden.fecha_envio_prod|date:"d/m/y H:i" }}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </a>
                                                                        {% if user.tipo_usuario.descripcion == 'USUARIO TALLER' and not orden.pago_aprobado %}
                                                                        <button onclick="mostrarFormulario('frmEnvioProducto', 'btnEnviaProducto', 'btnEnviaProducto')" class="btn btn-icon btn-warning rounded-circle button_img" type="button" data-repeater-delete style="position: absolute; top: 10px; right: 10px;"><i class="bx bx-edit"></i></button>
                                                                        {% endif %}
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if orden.factura_vta and perms.trn.ver_factura %}
                                                                    <div class="col-md-3 col-6">
                                                                        <a target="_blank" href="{{ orden.factura_vta.url }}">
                                                                            <div class="card border shadow-none mb-1 app-file-info">
                                                                                <div class="card-content">
                                                                                    <div class="app-file-content-logo card-img-top" style="align-content: center; text-align: center;">
                                                                                        <i class="bx bx-file" style="font-size: 30px;"></i>
                                                                                    </div>
                                                                                    <div class="card-body p-50">
                                                                                        <div class="app-file-details">
                                                                                            <div class="app-file-name font-size-small font-weight-bold">{% trans "Factura de venta" %}</div>
                                                                                            <div class="app-file-type font-size-small text-muted">{{ orden.fecha_venta|date:"d/m/y H:i" }}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </a>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if orden.cta_por_pagar and perms.trn.ver_cta_por_pagar %}
                                                                    <div class="col-md-3 col-6">
                                                                        <a target="_blank" href="{{ orden.cta_por_pagar.url }}">
                                                                            <div class="card border shadow-none mb-1 app-file-info">
                                                                                <div class="card-content">
                                                                                    <div class="app-file-content-logo card-img-top" style="align-content: center; text-align: center;">
                                                                                        <i class="bx bx-file" style="font-size: 30px;"></i>
                                                                                    </div>
                                                                                    <div class="card-body p-50">
                                                                                        <div class="app-file-details">
                                                                                            <div class="app-file-name font-size-small font-weight-bold">{% trans "Cuenta por pagar" %}</div>
                                                                                            <div class="app-file-type font-size-small text-muted">{{ orden.fecha_venta|date:"d/m/y H:i" }}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </a>
                                                                    </div>
                                                                    {% endif %}
                                                                    {% if orden.orden_compra and perms.trn.ver_orden_compra %}
                                                                    <div class="col-md-3 col-6">
                                                                        <a target="_blank" href="{{ orden.orden_compra.url }}">
                                                                            <div class="card border shadow-none mb-1 app-file-info">
                                                                                <div class="card-content">
                                                                                    <div class="app-file-content-logo card-img-top" style="align-content: center; text-align: center;">
                                                                                        <i class="bx bx-file" style="font-size: 30px;"></i>
                                                                                    </div>
                                                                                    <div class="card-body p-50">
                                                                                        <div class="app-file-details">
                                                                                            <div class="app-file-name font-size-small font-weight-bold">{% trans "Órden de compra" %}</div>
                                                                                            <div class="app-file-type font-size-small text-muted">{{ orden.fecha_venta|date:"d/m/y H:i" }}</div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </a>
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if rubros_asociados %}
                                    <div class="row" id="id_documentos">
                                        <div class="col-md-12 col-12">
                                            <div class="accordion collapse-icon accordion-icon-rotate" id="accordionWrapa_doc">
                                                <div class="card collapse-header">
                                                    <div id="heading_doc" class="card-header" data-toggle="collapse" data-target="#accordion_rubros" aria-expanded="false" aria-controls="accordion_rubros" role="tablist">
                                                        <span class="collapse-title">
                                                            <i class="bx bx-dollar-circle align-middle"></i>
                                                            <span class="align-middle">{% trans "Rubros asociados" %}</span>
                                                        </span>
                                                    </div>
                                                    <div id="accordion_rubros" role="tabpanel" data-parent="#accordionWrapa_doc" aria-labelledby="heading_doc" class="collapse">
                                                        <div class="card-content">
                                                            <div class="card-body">
                                                                <div class="row">
                                                                    <div class="col-md-12 col-12">
                                                                        <div class="table-responsive">
                                                                            <table id="id_lista_adicionales" class="table table-striped table-hover">
                                                                                <thead>
                                                                                    <th>{% trans "Descripción" %}</th>
                                                                                    <th>{% trans "Precio" %}</th>
                                                                                </thead>
                                                                                <tbody>
                                                                                    {% for rubro in rubros_asociados %}
                                                                                    <tr>
                                                                                        <td>{{ rubro.rubro.descripcion }}</td>
                                                                                        <td>{{ rubro.valor }}</td>
                                                                                    </tr>
                                                                                    {% endfor %}
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if orden.precio_final_venta and perms.trn.ver_detalle_costos %}
                                    <div class="row" id="id_documentos">
                                        <div class="col-md-12 col-12">
                                            <div class="accordion collapse-icon accordion-icon-rotate" id="accordionWrapa_doc">
                                                <div class="card collapse-header">
                                                    <div id="heading_doc" class="card-header" data-toggle="collapse" data-target="#accordion_costos" aria-expanded="false" aria-controls="accordion_costos" role="tablist">
                                                        <span class="collapse-title">
                                                            <i class="bx bx-dollar-circle align-middle"></i>
                                                            <span class="align-middle">{% trans "Detalle de costos" %}</span>
                                                        </span>
                                                    </div>
                                                    <div id="accordion_costos" role="tabpanel" data-parent="#accordionWrapa_doc" aria-labelledby="heading_doc" class="collapse">
                                                        <div class="card-content">
                                                            <div class="card-body">
                                                                <div class="row">
                                                                    <div class="col-md-4 col-6 mt-75">
                                                                        <p class="text-primary"><b>{% trans "Valores taller" %}</b></p>
                                                                        {% if user.tipo_usuario.descripcion == 'USUARIO OPERACIONES' %}
                                                                        <p class="text-success"><b>{% trans "Valores joyería" %}</b></p>
                                                                        {% endif %}
                                                                    </div>
                                                                    <div class="col-md-8 col-6 d-flex justify-content-end mt-75">
                                                                        <div class="invoice-subtotal">
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Materia prima" %}</span>
                                                                                <span id="val_mat_prima_ta" class="text-primary invoice-value"></span>
                                                                            </div>
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Mano de obra" %}</span>
                                                                                <span id="val_man_obra_ta" class="text-primary invoice-value"></span>
                                                                            </div>
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Rubros (fijo)" %}</span>
                                                                                <span id="val_rubros_ta" class="text-primary invoice-value"></span>
                                                                            </div>
                                                                           <!--  <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Adicional Color" %}</span>
                                                                                <span id="val_color_ta" class="text-primary invoice-value"></span>
                                                                            </div> -->
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Adic. Piedra Basic." %}</span>
                                                                                <span id="val_piedra_adicional" class="text-primary invoice-value"></span>
                                                                            </div>
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Adicionales" %}</span>
                                                                                <span id="val_adicionales" class="text-primary invoice-value"></span>
                                                                            </div>
                                                                            <div class="invoice-calc d-flex justify-content-between" id="divCosto">
                                                                                <span class="invoice-title">{% trans "Costo Envio" %}</span>
                                                                                <span id="costo_env" class="text-primary invoice-value"></span>
                                                                            </div>

                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Subtotal taller" %}</span>
                                                                                <span id="val_subtotal_ta" class="text-primary invoice-value"></span>
                                                                            </div>
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Impuestos" %}</span>
                                                                                <span id="val_impuestos_ta" class="text-primary invoice-value"></span>
                                                                            </div>
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Total taller" %}</span>
                                                                                <span id="val_total_ta" class="text-primary invoice-value"></span>
                                                                            </div>
                                                                            {% if user.tipo_usuario.descripcion == 'USUARIO OPERACIONES' %}
                                                                            <hr>
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Costo materia prima" %}</span>
                                                                                &
                                                                                <span id="val_mat_prima_op" class="text-success invoice-value"></span>
                                                                            </div>
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Utilidad fabricacion" %}</span>
                                                                                <span id="val_util_fabricacion" class="text-success invoice-value"></span>
                                                                            </div>
                                                                            <!-- <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Utilidad adicionales" %}</span>
                                                                                <span id="val_util_adicionales" class="text-success invoice-value"></span>
                                                                            </div> -->
                                                                           <!--  <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Utilidad total" %}</span>
                                                                                <span id="val_util_op" class="text-success invoice-value"></span>
                                                                            </div> -->
                                                                            
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Subtotal" %}</span>
                                                                                <span id="val_subtotal_op" class="text-success invoice-value"></span>
                                                                            </div>
                                                                            <div class="invoice-calc d-flex justify-content-between">
                                                                                <span class="invoice-title">{% trans "Impuestos" %}</span>
                                                                                <span id="val_impuestos_op" class="text-success invoice-value"></span>
                                                                            </div>
                                                                            {% endif %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if user.tipo_usuario.descripcion == 'USUARIO OPERACIONES' %}
                                    <div class="row">
                                        <div class="col-12 d-flex justify-content-end">
                                            <input id="id_precio" disabled name="precio" type="text" class="caja">
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if perms.trn.envio_material_joyeria %}
                                    <div class="divider" id="id_div_frmEnvioMaterial">
                                        <div class="divider-text">{% trans "Enviar material" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmEnvioMaterial" name="EnvioMaterial" enctype="multipart/form-data">
                                            {% csrf_token %}
                                                <div class="col-md-12 col-12">
                                                    <div class="row">
                                                        <div class="col-md-4 col-12">
                                                            <div class="form-label-group">
                                                                <input id="id_gramos_enviados" lang="en-150" min="0.00" step="0.01" type="number" class="form-control">
                                                                <label
                                                                    for="email-id-column">{% trans "Gramos enviados" %}</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4 col-12">
                                                            <div class="form-label-group">
                                                                <input id="id_comp_envio_op" type="file" class="form-control">
                                                                <label
                                                                    for="email-id-column">{% trans "Comprobante de envío" %}</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4 col-12">
                                                            <div class="form-label-group">
                                                                <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary">
                                                                    <i class="bx bx-x d-block d-sm-none"></i>
                                                                    <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                                </a>
                                                                <button type="button" onclick="envioMaterial()" class="btn btn-primary">
                                                                    {% trans "Listo" %}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="divider" id="id_div_frmRecibeMaterial">
                                        <div class="divider-text">{% trans "Recibir material" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmRecibeMaterial" name="RecibeMaterial" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row">
                                                <div class="col-md-8 col-12">
                                                    <div class="form-label-group">
                                                        <input id="id_gramos_recibidos" lang="en-150" min="0.00" step="0.01" type="number" class="form-control">
                                                        <label
                                                            for="email-id-column">{% trans "Gramos recibidos" %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary">
                                                            <i class="bx bx-x d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                        </a>
                                                        <button type="button" onclick="recibeMaterial()" class="btn btn-primary">
                                                            {% trans "Listo" %}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="divider" id="id_div_frmAnulaOrden">
                                        <div class="divider-text">{% trans "Anular órden" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmAnulaOrden" name="AnulaOrden" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row">
                                                <div class="col-md-8 col-12">
                                                    <div class="form-label-group">
                                                        <textarea class="form-control" name="anular_observacion" id="id_anular_observacion" rows="3"></textarea>
                                                        <label
                                                            for="email-id-column">{% trans "Observación" %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary">
                                                            <i class="bx bx-x d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                        </a>
                                                        <button type="button" onclick="anularOrden()" class="btn btn-primary">
                                                            {% trans "Listo" %}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="divider" id="id_div_frmFinalizarTrabajo">
                                        <div class="divider-text">{% trans "Finalizar trabajo" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmFinalizarTrabajo" name="FinalizarTrabajo" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row">
                                                {% if user.taller.cargar_img_fin_trabajo %}
                                                <div class="col-md-12 col-12">
                                                    <div id="id_img_lista" class="row">
                                                        <div id="elemento_1" class="col-md-3 col-12 col-sm-12 item_img">
                                                            <img id="id_img_tmp_1" name="imagentmp" src="{% static 'base/img/icons/nofoto2.png' %}"  width="150px" height="150px" class="imgtmp center img-fluid pointer" width="100%">
                                                            <input onchange="seleccionarImagen('id_img_tmp_1','id_imagen_1')" type="file" name="imagen" id="id_imagen_1" class="inputimage center pointer" width="100%">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-12 col-12">
                                                    <p id="id_peso_max_peticion"></p>
                                                </div>
                                                {% endif %}
                                                <div class="col-md-8 col-12">
                                                    {% if user.taller.cargar_img_fin_trabajo %}
                                                    <button id="btnAgregarImagen" type="button" class="btn btn-icon rounded-circle btn-success glow mr-1 mb-1" style="padding: 6px 10px;" onclick="agregarImg()">
                                                        <i class="bx bxs-image-add fa-2x sr-icons"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <input id="id_peso_final" step="0.01" type="number" class="form-control">
                                                        <label
                                                            for="email-id-column">{% trans "Peso Final" %}</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-12 d-flex justify-content-end">
                                                    <button id="btnGuardar" type="button" onclick="ValidarFinalizarTrabajo()" class="btn btn-primary mr-1 mb-1">{% trans " Listo" %}</button>
                                                    <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary mr-1 mb-1">
                                                        <i class="bx bx-x d-block d-sm-none"></i>
                                                        <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                    </a>
                                                </div>
                                            </div>
                                            </form>
                                        </div>
                                    </div>
                                    {% if perms.trn.enviar_producto %}
                                    <div class="divider" id="id_div_frmEnvioProducto">
                                        <div class="divider-text">{% trans "Enviar producto" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmEnvioProducto" name="EnvioProducto" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row">
                                                <div class="col-md-4 col-12" >
                                                    <div class="form-label-group" data-toggle="tooltip" data-placement="top" title data-original-title="{{tool_comp_env}}">
                                                        <input id="id_comp_envio_ta" type="file" class="form-control" >
                                                        <label 
                                                            id="comprobante_env" for="email-id-column">{% trans "Comprobante de envío" %}</label>
                                                        
                                                    </div>
                                                </div>
                                                <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <input id="id_costo_envio" step="0.01" type="number" class="form-control">
                                                        <label
                                                            id="lbl_costo_envio" for="email-id-column">{% trans "Costo envío" %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary">
                                                            <i class="bx bx-x d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                        </a>
                                                        <button type="button" onclick="enviarProducto()" class="btn btn-primary">
                                                            {% trans "Listo" %}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            </form>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="divider" id="id_div_frmRecibeProducto">
                                        <div class="divider-text">{% trans "Recibir producto" %}</div>
                                        <br>
                                    </div>
                                        <div class="row">
                                            <div class="col-md-12 col-12">
                                                <form method="POST" id="frmRecibeProducto" name="RecibeProducto" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <div class="row">
                                                    <!-- <div class="col-md-8 col-12">
                                                        <div class="form-label-group">
                                                            <input id="id_factura_taller" type="file" class="form-control">
                                                            <label
                                                                for="email-id-column">{% trans "Factura taller" %}</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4 col-12">
                                                        <div class="form-label-group">
                                                            <button type="button" class="btn btn-light-secondary" data-dismiss="modal">
                                                                <i class="bx bx-x d-block d-sm-none"></i>
                                                                <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                            </button>
                                                            <button type="button" onclick="recibirProducto()" class="btn btn-primary">
                                                                {% trans "Listo" %}
                                                            </button>
                                                        </div>
                                                    </div> -->
                                                </div>
                                                </form>
                                            </div>
                                        </div>
                                    
                                    <div class="divider" id="id_div_frmCargarDocumentosOp">
                                        <div class="divider-text">{% trans "Cargar documentos" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmCargarDocumentosOp" name="CargarDocumentosOp" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row">
                                                <div class="col-md-4 col-12" >
                                                    {% if user.grupo_empresarial.cta_por_pagar %}
                                                    <div class="form-label-group" data-toggle="tooltip" data-placement="top" title data-original-title="{{tool_cta_por_pag}}">
                                                        <input id="id_cta_por_pagar" type="file" class="form-control">
                                                        <label 
                                                            for="email-id-column">{% trans "Cuenta por pagar" %}</label>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4 col-12">
                                                    {% if user.grupo_empresarial.orden_compra %}
                                                    <div class="form-label-group" data-toggle="tooltip" data-placement="top" title data-original-title="{{tool_ordn_compr}}">
                                                        <input id="id_orden_compra" type="file" class="form-control">
                                                        <label
                                                            for="email-id-column">{% trans "Órden de compra" %}</label>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary">
                                                            <i class="bx bx-x d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                        </a>
                                                        <button type="button" onclick="cargarDocumentosOp()" class="btn btn-primary">
                                                            <i class="bx bx-check d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Listo" %}</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="divider" id="id_div_frmCargarDocumentosTa">
                                        <div class="divider-text">{% trans "Cargar documentos" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmCargarDocumentosTa" name="CargarDocumentosTa" enctype="multipart/form-data">
                                                {% csrf_token %}
                                                <div class="row">
                                                    <div class="col-md-8 col-12">
                                                        <div class="form-label-group" >
                                                            <input id="id_factura_taller" type="file" class="form-control">
                                                            <label
                                                                for="email-id-column">{% trans "Factura taller" %}</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4 col-12">
                                                        <div class="form-label-group">
                                                            <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary">
                                                                <i class="bx bx-x d-block d-sm-none"></i>
                                                                <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                            </a>
                                                            <button type="button" onclick="cargarDocumentosTa()" class="btn btn-primary">
                                                                {% trans "Listo" %}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="divider" id="id_div_frmDevolucionProducto">
                                        <div class="divider-text">{% trans "Devolver producto" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmDevolucionProducto" name="DevolucionProducto" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row">
                                                <div class="col-md-8 col-12">
                                                    <div class="form-label-group">
                                                        <textarea class="form-control" name="devolver_observacion" id="id_devolver_observacion" rows="3"></textarea>
                                                        <label
                                                            for="email-id-column">{% trans "Observación" %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary">
                                                            <i class="bx bx-x d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                        </a>
                                                        <button type="button" onclick="devolverProducto()" class="btn btn-primary">
                                                            <i class="bx bx-check d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Listo" %}</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="divider" id="id_div_frmVentaOrden">
                                        <div class="divider-text">{% trans "Finalizar órden" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmVentaOrden" name="VentaOrden" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row">
                                                <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <input id="id_factura_vta" type="file" class="form-control">
                                                        <label
                                                            for="email-id-column">{% trans "Factura de venta" %}</label>
                                                    </div>
                                                </div>
                                                <!-- <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <input id="id_cta_por_pagar" type="file" class="form-control">
                                                        <label
                                                            for="email-id-column">{% trans "Cuenta por pagar" %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <input id="id_orden_compra" type="file" class="form-control">
                                                        <label
                                                            for="email-id-column">{% trans "Órden de compra" %}</label>
                                                    </div>
                                                </div> -->
                                                <div class="col-md-5 col-12">
                                                    <div class="form-label-group">
                                                        <textarea class="form-control" name="obs_venta" id="id_obs_venta" rows="2"></textarea>
                                                        <label
                                                            for="email-id-column">{% trans "Observación" %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 col-12">
                                                    <div class="form-label-group">
                                                        <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary">
                                                            <i class="bx bx-x d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                        </a>
                                                        <button type="button" onclick="finalizarOrden()" class="btn btn-primary">
                                                            <i class="bx bx-check d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Listo" %}</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="divider" id="id_div_frmFinalizarSinVenta">
                                        <div class="divider-text">{% trans "Finalizar sin venta" %}</div>
                                        <br>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 col-12">
                                            <form method="POST" id="frmFinalizarSinVenta" name="FinalizarSinVenta" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="row">
                                                <!-- <div class="col-md-4 col-12">
                                                    <div class="form-label-group">
                                                        <input id="id_cta_por_pagar" type="file" class="form-control">
                                                        <label
                                                            for="email-id-column">{% trans "Cuenta por pagar" %}</label>
                                                    </div>
                                                    <div class="form-label-group">
                                                        <input id="id_orden_compra" type="file" class="form-control">
                                                        <label
                                                            for="email-id-column">{% trans "Órden de compra" %}</label>
                                                    </div>
                                                </div> -->
                                                <div class="col-md-9 col-12">
                                                    <div class="form-label-group">
                                                        <textarea class="form-control" name="sin_venta_observacion" id="id_sin_venta_observacion" rows="3"></textarea>
                                                        <label
                                                            for="email-id-column">{% trans "Observación" %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 col-12">
                                                    <div class="form-label-group">
                                                        <a href="{% url 'trn:ordenes_lista' %}" class="btn btn-light-secondary">
                                                            <i class="bx bx-x d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
                                                        </a>
                                                        <button type="button" onclick="finalizarSinVenta()" class="btn btn-primary">
                                                            <i class="bx bx-check d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Listo" %}</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 d-flex justify-content-end">
                                            <a href="{% url 'trn:ordenes_lista' %}" id="btnCancelar" type="button" class="btn btn-light-secondary">
                                                <i class="bx bx-x d-block d-sm-none"></i>
                                                <span class="d-none d-sm-block">{% trans "Atrás" %}</span>
                                            </a>   

                                                {% if orden.estado_id == 12 and user.tipo_usuario_id == 3 %}
                                                {% if perms.trn.envio_material_joyeria %}
                                                <button id="btnEntregaMaterial" type="button" onclick="mostrarFormulario('frmEnvioMaterial', 'btnEntregaMaterial', 'btnEntregaMaterial')" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Entrega de material" %}</span>
                                                </button>
                                                {% endif %}
                                                {% endif %}
                                                {% if orden.estado_id == 13 and user.tipo_usuario_id == 2 %}
                                                <button id="btnRecibeMaterial" type="button" onclick="mostrarFormulario('frmRecibeMaterial', 'btnRecibeMaterial', 'btnAnulaOrden')" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Recibir material" %}</span>
                                                </button>
                                                <button id="btnAnulaOrden" type="button" onclick="mostrarFormulario('frmAnulaOrden', 'btnRecibeMaterial', 'btnAnulaOrden')" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Anular Órden" %}</span>
                                                </button>
                                                {% endif %}
                                                {% if orden.estado_id == 20 and user.tipo_usuario_id == 2    %}
                                                {% if perms.trn.iniciar_orden %}
                                                <button id="btnIniciarTrabajo" type="button" onclick="iniciarTrabajo(14)" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Iniciar Trabajo" %}</span>
                                                </button>
                                                {% endif %}
                                                {% if perms.trn.anular_orden %}
                                                <button id="btnAnulaOrden" type="button" onclick="mostrarFormulario('frmAnulaOrden', 'btnRecibeMaterial', 'btnAnulaOrden')" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Anular Órden" %}</span>
                                                </button>
                                                {% endif %}
                                                {% endif %}
                                                {% if orden.estado_id == 14 and user.tipo_usuario_id == 2 %}
                                                {% if perms.trn.finalizar_trabajo %}
                                                <button id="btnFinalizaTrabajo" type="button" onclick="mostrarFormulario('frmFinalizarTrabajo', 'btnFinalizaTrabajo', 'btnFinalizaTrabajo')" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Finalizar trabajo" %}</span>
                                                </button>
                                                {% endif %}
                                                {% endif %}
                                                {% if orden.estado_id == 15 and user.tipo_usuario_id == 2  and perms.trn.enviar_producto %}
                                                <button id="btnEnviaProducto" type="button" onclick="mostrarFormulario('frmEnvioProducto', 'btnEnviaProducto', 'btnEnviaProducto')" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Enviar producto" %}</span>
                                                </button>
                                                {% endif %}
                                                {% if orden.estado_id == 20  and user.tipo_usuario_id == 3 and orden.externa %}
                                                    <button id="btnRecibeProducto" type="button" onclick="recibirProducto()" name="aceptar" class="btn btn-primary ml-1">
                                                        <i class="bx bx-check d-block d-sm-none"></i>
                                                        <span class="d-none d-sm-block">{% trans "Recibir producto" %}</span>
                                                    </button>
                                                {% endif %}


                                                {% if orden.estado_id == 16 and user.tipo_usuario_id == 3 %}
                                                <button id="btnRecibeProducto" type="button" onclick="recibirProducto()" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Recibir producto" %}</span>
                                                </button>
<!--                                                 <button id="btnDevolverProducto" type="button" onclick="mostrarFormulario('frmDevolucionProducto', 'btnRecibeProducto', 'btnDevolverProducto')" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Devolver producto" %}</span>
                                                </button> -->
                                                    <button id="btnDevolverProducto" type="button" onclick="devolverProd()" name="aceptar" class="btn btn-primary ml-1">
                                                    <i class="bx bx-check d-block d-sm-none"></i>
                                                    <span class="d-none d-sm-block">{% trans "Devolver producto" %}</span>
                                                </button>
                                                {% endif %}

                                                {% if orden.estado_id == 17 and user.tipo_usuario_id == 3 %}
                                                    {% if user.grupo_empresarial.cta_por_pagar or user.grupo_empresarial.orden_compra  %}

                                                        {% if not orden.cta_por_pagar %}
                                                        <button id="btnCargaDocOp" type="button" onclick="mostrarFormulario('frmCargarDocumentosOp', 'btnCargaDocOp', 'btnCargaDocOp')" name="aceptar" class="btn btn-primary ml-1">
                                                            <i class="bx bx-receipt d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Cargar documentos" %}</span>
                                                        </button>
                                                        {% else %}
                                                            {% if not orden.orden_compra %}
                                                            <button id="btnCargaDocOp" type="button" onclick="mostrarFormulario('frmCargarDocumentosOp', 'btnCargaDocOp', 'btnCargaDocOp')" name="aceptar" class="btn btn-primary ml-1">
                                                                <i class="bx bx-receipt d-block d-sm-none"></i>
                                                                <span class="d-none d-sm-block">{% trans "Cargar documentos" %}</span>
                                                            </button>
                                                            {% else %}
                                                            <button id="btnVentaOrden" type="button" onclick="mostrarFormulario('frmVentaOrden', 'btnVentaOrden', 'btnFinalizaOrden')" name="aceptar" class="btn btn-primary ml-1">
                                                                <i class="bx bx-receipt d-block d-sm-none"></i>
                                                                <span class="d-none d-sm-block">{% trans "Producto vendido" %}</span>
                                                            </button>
                                                            <button id="btnFinalizaOrden" type="button" onclick="mostrarFormulario('frmFinalizarSinVenta', 'btnVentaOrden', 'btnFinalizaOrden')" name="aceptar" class="btn btn-primary ml-1">
                                                                <i class="bx bx-shopping-bag d-block d-sm-none"></i>
                                                                <span class="d-none d-sm-block">{% trans "Producto no vendido" %}</span>
                                                            </button>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% else %}
                                                        <button id="btnVentaOrden" type="button" onclick="mostrarFormulario('frmVentaOrden', 'btnVentaOrden', 'btnFinalizaOrden')" name="aceptar" class="btn btn-primary ml-1">
                                                            <i class="bx bx-receipt d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Producto vendido" %}</span>
                                                        </button>
                                                        <button id="btnFinalizaOrden" type="button" onclick="mostrarFormulario('frmFinalizarSinVenta', 'btnVentaOrden', 'btnFinalizaOrden')" name="aceptar" class="btn btn-primary ml-1">
                                                            <i class="bx bx-shopping-bag d-block d-sm-none"></i>
                                                            <span class="d-none d-sm-block">{% trans "Producto no vendido" %}</span>
                                                        </button>
                                                    {% endif %}
                                                {% endif %}
                                                {% if orden.estado_id == 17 and user.tipo_usuario_id == 2 %}
                                                    {% if orden.usuario.grupo_empresarial.factura_taller and not orden.factura_taller %}
                                                    <button id="btnCargaFactTa" type="button" onclick="mostrarFormulario('frmCargarDocumentosTa', 'btnCargaFactTa', 'btnCargaFactTa')" name="aceptar" class="btn btn-primary ml-1">
                                                        <i class="bx bx-receipt d-block d-sm-none"></i>
                                                        <span class="d-none d-sm-block">{% trans "Cargar factura" %}</span>
                                                    </button>
                                                    {% endif %}
                                                {% endif %}
                                            {% if perms.trn.pagos_aprobados and not orden.pago_aprobado %}
                                           
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>    
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
<div class="loader">
    <div class="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
</div>


<div class="modal fade text-left" id="modal_select_obs" tabindex="-1" role="dialog" aria-labelledby="myModalLabel15" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <!-- <input type="hidden" class="id_obs_eliminar"> -->
            <div class="modal-header bg-warning">
                <h5 class="modal-title white" id="myModalLabel15">Seleccione motivo de Devolucion.</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i class="bx bx-x"></i>
                </button>
            </div>
            <div class="modal-body">    
               <div class="col-md-12 col-12">
                    <div class="form-label-group">
                        <select name="tienda" id="id_observacion" class="form-control">
                            <option value="0">{% trans "Seleccionar" %}</option>
                            {% for rechazo in rechazos %}
                            <option 

                                value="{{ rechazo.id_obs_rechazo }}"
                                descripcion='{{ rechazo.titulo_rechazo }}'
                                detalle='{{rechazo.observacion_rechazo}}'
                                required>

                            {{ rechazo.titulo_rechazo }}

                            </option>
                            {% endfor %}
                        </select>
                        <input type="text" hidden>

                        <label
                            for="id_obs">{% trans "Motivos de Devolucion:" %}
                        </label>
                        <div id="tienda_error" class="invalid-feedback">
                            {% trans "Seleccione un Motivo" %}
                        </div>
                    </div>
                    <div class="row" id="div_observacion">
                        <div class="col-md-12 col-12">
                            <label
                                for="id_obs">{% trans "Detalle definido:" %}
                            </label>
                            <textarea id="id_detalle_obs" class="form-control" disabled></textarea>
                        </div>
                        <div class="col-md-12 col-12">
                            <label
                                for="id_obs">{% trans "Detalle adicional:" %}
                            </label>
                            <textarea id="id_detalle_adicional" class="form-control"></textarea>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light-secondary" data-dismiss="modal">
                    <i class="bx bx-x d-block d-sm-none"></i>
                    <span class="d-none d-sm-block">Cancelar</span>
                </button>
                <button type="button" class="btn btn-primary ml-1 " onclick="devolverProducto()">
                    <i class="bx bx-check d-block d-sm-none"></i>
                    <span class="d-none d-sm-block">Aceptar</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block js_page %}
{% load static %}
    <script src="{% static 'base/app-assets/js/scripts/tooltip/tooltip.min.js' %}"></script>
    <script src="{% static 'base/app-assets/js/scripts/tooltip/tooltip.js' %}"></script>
    <!-- <script type="text/javascript" src="{% static 'base/assets/js/transaccion.js' %}"></script> -->
    <script type="text/javascript" src="{% static 'base/assets/js/transaccion2.js' %}"></script>



    <!-- <script src="{% static 'base/app-assets/vendors/js/charts/apexcharts.min.js' %}"></script> -->
    <!-- <script src="{% static 'base/app-assets/vendors/js/charts/apexcharts.min.js' %}"></script> -->

<script>
    
    // valores taller
    var costo_gramo_base_taller = parseFloat('{{ orden.costo_gramo_base_taller }}'.replace(/,/, '.'));
    var precio_gramo_base_taller = parseFloat('{{ orden.precio_gramo_base_taller }}'.replace(/,/, '.'));
    var prct_utilidad_base_taller = parseFloat('{{ orden.prct_utilidad_base_taller }}'.replace(/,/, '.'));
    var costo_base_total_ta = parseFloat('{{ orden.costo_base_total_ta }}'.replace(/,/, '.'));
    var utilidad_base_taller = parseFloat('{{ orden.utilidad_base_taller }}'.replace(/,/, '.'));
    var precio_base_total_ta = parseFloat('{{ orden.precio_base_total_ta }}'.replace(/,/, '.'));

    var costa_color_unitario = parseFloat('{{ orden.costo_color_unitario }}'.replace(/,/, '.'));
    var costa_color_total = parseFloat('{{ orden.costo_color_total }}'.replace(/,/, '.'));


    var costo_fabricacion_unitario = parseFloat('{{ orden.costo_fabricacion_unitario }}'.replace(/,/, '.'));

    var costo_total_fabricacion_ta = parseFloat('{{ orden.costo_total_fabricacion_ta }}'.replace(/,/, '.'));
    var prct_util_fabricacion_taller = parseFloat('{{ orden.prct_util_sobre_fabrica_ta }}'.replace(/,/, '.'));
    var utilidad_fabricacion_taller = parseFloat('{{ orden.util_sobre_fabrica_ta }}'.replace(/,/, '.'));
    var precio_fabricacion_unitario = parseFloat('{{ orden.precio_fabricacion_unitario }}'.replace(/,/, '.'));
    var precio_fabricacion_total_ta = parseFloat('{{ orden.precio_fabricacion_total }}'.replace(/,/, '.'));

    var costo_piedras_basicas = parseFloat('{{ orden.costo_piedras_basicas }}'.replace(/,/, '.'));
    var costo_color_unitario = parseFloat('{{ orden.costo_color_unitario }}'.replace(/,/, '.'));

    var precioColorTotalTaller = parseFloat('{{ orden.costo_color_total }}'.replace(/,/, '.'));
    var subtotal_taller = parseFloat('{{ orden.subtotal_taller }}'.replace(/,/, '.'));

    // console.log(subtotal_taller)

    var prct_impuestos_taller = parseFloat('{{ orden.prct_impuestos_ta }}'.replace(/,/, '.'));
    var impuestos_taller = parseFloat('{{ orden.impuestos_taller }}'.replace(/,/, '.'));
    var total_taller = parseFloat('{{ orden.total_taller }}'.replace(/,/, '.'));
    var total_taller_recalculado =  parseFloat('{{ orden.total_taller_recalculado }}'.replace(/,/, '.'));

    // Valores extras
    var costo_piedras_taller = 0;
    var prct_util_piedras_taller = 0;
    var utilidad_piedras_taller = 0;
    var precio_piedras_taller = parseFloat('{{orden.precio_piedras_taller}}'.replace(/,/, '.'));
    var costo_adicionales_taller = 0;
    var prct_util_adicionales_taller = 0;
    var utilidad_adicionales_taller = 0;
    var precio_adicionales_taller = parseFloat('{{orden.precio_adicionales_taller}}'.replace(/,/, '.'));;
    var costoManoObraTotal = 0;

    var total_piedras_op = 0;
    var total_adicional_piedrasicionales_op = 0;
    var impuestos_piedras_op = 0;
    var impuestos_adicionales_op = 0;
// <<<<<<< HEAD
    // var total_adicional_piedrasicionals=0;
    var total_piedrass =0;
    var total_adicional_piedras=0;
// =======

    let total_adicional_piedrasicionals=0;
    var total_piedra_alianza =0;
    // var total_adicional_piedras = 0;
    
// >>>>>>> develop4
    // valores joyería
    var costo_gramo_base_op = parseFloat('{{ orden.tienda.sociedad.costo_gramo_base }}'.replace(/,/, '.'));

    // alert(costo_gramo_base_op)
    var precio_gramo_base_op = parseFloat('{{ orden.tienda.sociedad.precio_gramo_base }}'.replace(/,/, '.'));
    var costo_base_total_op = parseFloat('{{ orden.costo_base_total_op }}'.replace(/,/, '.'));
    var prct_utilidad_base_op = parseFloat('{{ orden.prct_util_sobre_base_op }}'.replace(/,/, '.'));
    var utilidad_base_op = parseFloat('{{ orden.util_sobre_base_op }}'.replace(/,/, '.'));
    var precio_base_total_op = parseFloat('{{ orden.precio_base_total_op }}'.replace(/,/, '.'));

    var prct_util_fabricacion_op = parseFloat('{{ orden.prct_util_sobre_fabrica_op }}'.replace(/,/, '.'));
    var precio_unitario_op = parseFloat('{{ orden.precio_unitario_op }}'.replace(/,/, '.'));
    var utilidad_fabricacion_op = parseFloat('{{ orden.util_sobre_fabrica_op }}'.replace(/,/, '.'));

    var precio_fabricacion_total_op = parseFloat('{{ orden.precio_fabricacion_total_op }}'.replace(/,/, '.'));

    var precioColorTotalOp = parseFloat('{{ orden.costo_color_total }}'.replace(/,/, '.'));


    var subtotal_op = 0;
    var impuestos_op = 0;
    var total_fabricacion_op = 0;
    var subtotal_orden = parseFloat('{{ orden.subtotal_orden }}'.replace(/,/, '.'));
    var prct_impuestos_joyeria = parseFloat('{{ orden.prct_impuestos_op }}'.replace(/,/, '.'));
    var impuestos_orden = parseFloat('{{ orden.impuestos_op }}'.replace(/,/, '.'));
    var precio_sistema = parseFloat('{{ orden.precio_sistema }}'.replace(/,/, '.'));
    var descuento = parseFloat('{{ orden.descuento_orden }}'.replace(/,/, '.'));
    var precio_final_orden = parseFloat('{{ orden.precio_final_venta }}'.replace(/,/, '.'));

    // generales
    var simbolo_moneda = '{{ user.pais.simbolo_moneda }}';
    var decimales = '{{ user.pais.decimales }}';
    var regla_calculo_taller = '{{ orden.categoria.precio_taller_obj.tipo.regla_calculo.descripcion }}';
    var precio_definido_op = '{{ orden.categoria.precio_empresa_obj }}';
    
    var regla_calculo_op;
    if(precio_definido_op){
        
        regla_calculo_op = '{{ orden.categoria.precio_empresa_obj.tipo.regla_calculo.descripcion }}';

    } else {
        regla_calculo_op = '{{ orden.categoria.precio_empresa_obj.tipo.regla_calculo.descripcion }}';
    }

    var tipo_catalogo = '{{ item.categoria.division.tipo_catalogo.descripcion }}';
    var item_categoria = '{{ item.categoria.precio_taller_obj.tipo.descripcion }}';
    var tipo_transaccion = 1;
    var total_rubros = parseFloat('{{ orden.costo_total_rubros }}'.replace(/,/, '.'));

    var cargarImagenes = ('{{ user.taller.cargar_img_fin_trabajo }}'.toLowerCase() === 'true');
    var recalcular = ('{{ user.taller.recalcular_precio }}'.toLowerCase() === 'true');
    console.log(recalcular, 'recalcular ')
    let peso_max_data = parseInt('{{ PESO_MAX_DATA }}');
    var categoria_alianzas = '{{orden.categoria.categoria_alianzas}}'

    // detener el evento onclick de la tecla enter
    window.addEventListener("keypress", function(event){
    if (event.keyCode == 13){
        event.preventDefault();
        }
    }, false);

    // datos para el detalle de las alianzas
    var talla_hombre = '{{talla_hombre}}';
    var talla_mujer = '{{talla_mujer}}';
    var inscripcion_hombre = '{{inscripcion_hombre}}';
    var inscripcion_mujer = '{{inscripcion_mujer}}';

    var total_piedra = 0;
    var total_piedra_ab = 0;
    var total_utilidad_piedra_ab = 0;
    var utilidad_piedra = 0;
    var precio_recalculado_total_op =  parseFloat('{{ orden.precio_recalculado }}'.replace(/,/, '.'));
    console.log(precio_recalculado_total_op)
    var total_utilidad_adicionales = 0;
    var utilidad_adicionales = 0;

    var precioTotalPiedrasOp = 0;
    var precioTotalAdicionalTaler = 0;

    var impuestos_adicionales = 0;
    var impuestos_piedras = 0;

    var precioTotalPiedrasTaller = 0;
    var utilidadTotalPiedrasOp = 0;
    var utilidad_fabricacion_taller = parseFloat('{{orden.util_sobre_fabrica_ta}}'.replace(/,/, '.'));

    var origen = '{{orden.origen_material.descripcion}}';
    var tallerPrecioTipo = '{{ item.categoria.precio_taller_obj.tipo.descripcion }}';
    var tiendaPrecioTipo = '{{item.categoria.precio_empresa_obj.tipo.descripcion }}';

    var item_solicitud = '{{item_solicitud}}'
    // alert(item_solicitud)
    if(item_solicitud !== 'None'){
        var tallerPrecioTipo = '{{item_solicitud.categoria.precio_taller_obj.tipo.descripcion}}';
        var tiendaPrecioTipo = '{{item_solicitud.categoria.precio_empresa_obj.tipo.descripcion}}';

    }

    costo_envio = parseFloat('{{orden.costo_envio}}'.replace(/,/, '.'));

    envioIncluido = ('{{ config.envio_incluido }}'.toLowerCase() === 'true');



    var costo_total_rubros = parseFloat('{{costo_total_rubros}}'.replace(/,/, '.'));
    var piedraLista = {{piedraLista|safe}};
    var adicionalesLista = {{adicionalesLista|safe}};
    var peso_solicitado = '{{orden.peso_solicitado}}';

    var peso_final = '{{orden.peso_final}}';
    if(peso_final !== 'None'){
        peso_solicitado = peso_final;
    }
    let transaccionCalculada = {}


    let fabricacion_interna = ('{{orden.fabricacion_interna}}'.toLowerCase() === 'true' )
    console.log(fabricacion_interna, 'fabricacion_interna')


    // if(fabricacion_interna !== false){
    //     prct_impuestos_taller = 0;
    //     prct_util_fabricacion_taller = 0;
    //     prct_util_fabricacion_op = 0;
    //     prct_impuestos_joyeria = 0;
    // }


    let itemDatos = {

        'tallerPrecioTipo': tallerPrecioTipo,
        'tiendaPrecioTipo': tiendaPrecioTipo,
        'materiaPrimaOrigen': origen,
        'unidades': 1,
        'gramos': parseFloat(peso_solicitado),

        'adicionalesLista': [],
        'piedrasLista': [],

        'manoObraCostoUnitario': costo_fabricacion_unitario,
        'manoObraUtilidadPrct': prct_util_fabricacion_taller,
        'manoObraPrecioUnitario': precio_fabricacion_unitario,
        'materiaPrimaTallerCostoUnitario': costo_gramo_base_taller,
        'materiaPrimaTallerPrecioUnitario': precio_gramo_base_taller,
        'rubrosCostoTotal': parseFloat(costo_total_rubros),
        'piedrasBasicasCosto': costo_piedras_basicas,
        'colorCostoAdicionalUnitario': costo_color_unitario,
        'impuestosTallerPrct': prct_impuestos_taller,

        'materiaPrimaTiendaCostoUnitario': costo_gramo_base_op,
        'materiaPrimaTiendaPrecioUnitario': precio_gramo_base_op,
        'fabricacionTiendaUtilidadPrct': prct_util_fabricacion_op,
        'precioFinalTiendaUnitario': precio_unitario_op,
        'impuestosTiendaPrct': prct_impuestos_joyeria,
        'descuento': 0,
        'precioNegociado': 0,
        'costoEnvio': parseFloat(costo_envio),

        'costoColorAdicionalTallerUnitario': 0,
        'precioColorAdicionalTallerUnitario': 0,
        'precioColorAdicionalTiendaUnitario': 0,
        'fabricacionDividida': 0,
        'pesoSolicitado': 0,
        'fabricacionInterna': false

    }
    console.log(itemDatos);


    $(document).ready(function () {

        $('.loader').hide();

        // var adicionales_lista = {{adicionales_relacionados|safe}};
        // var piedras_lista = {{piedras_relacionadas|safe}};

        // itemDatos.piedrasLista = [];
        // itemDatos.adicionalesLista = [];
        // adicionalesLista.forEach(adicional => {
        //     itemDatos.adicionalesLista.push(adicional);
        // })
        // piedraLista.forEach( piedra => {
        //     itemDatos.piedrasLista.push(piedra);
        // })
        // console.log(itemDatos)
        // transaccionCalculada = calcularValoresTransaccion(itemDatos)


        var adicionales_l = {{adicionales_listado|safe}};
            adicionales_l.forEach(adicional => {
            total_adicional_piedrasicionals=parseFloat(adicional.precio_ta);
            console.log(total_adicional_piedrasicionals)
            // total_adicional_piedrasicionales_op=parseFloat(adicional[4]);
            // precioTotalAdicionalTaler += total_adicional_piedrasicionales_op
            // utilidad_adicionales = parseFloat(adicional[4]) - parseFloat(adicional[5]);
            // total_utilidad_adicionales += utilidad_adicionales;
            // total_adicional_piedrasicionals += total_adicional_piedrasicional
            // impuestos_adicionales = precioTotalAdicionalTaler * (prct_impuestos_joyeria/100)
            // impuestos_adicionales_op += impuestos_adicionales

        })
        // console.log(adicionales)


        var piedras_l = {{piedras_listado|safe}};
        console.log('******')
        piedras_l.forEach(piedra => {
            console.log(piedra)
            total_piedra=parseFloat(piedra.precio_ta);
            // total_piedras_op = parseFloat(piedra[4]);
            // precioTotalPiedrasOp += total_piedras_op;
            // utilidad_piedra = parseFloat(piedra[4]) - parseFloat(piedra[3]);
            // total_utilidad_piedra_ab += utilidad_piedra

            // total_piedrass += total_piedra;
            // impuestos_piedras = precioTotalPiedrasOp * (prct_impuestos_joyeria/100);
            // impuestos_piedras_op += impuestos_piedras;
        })

        $('input').css('background-color','#FBFBFB');
        $('textarea').css('background-color','#FBFBFB');
        $('div.carousel-item:first').addClass('active');
        $('div > div.carousel-item:first', '#carousel-imagenes').addClass('active');

        if(costo_envio === 0){
            // $('#divCosto').hide()

            $('#costo_env').text(simbolo_moneda + ' ' + (costo_envio).toFixed(2));
        }
        else{
            $('#costo_env').text(simbolo_moneda + ' ' + (costo_envio).toFixed(2));
        }


        $('#id_observacion').on('change', function(){
            var detalle = $('option:selected', '#id_observacion').attr('detalle');
            if(detalle === undefined){
                $('#div_observacion').hide();
                // mensaje('{% trans "Seleccione un motivo" %}', 'orange');
                // return;
            }else{
                $('#div_observacion').show();
            }
            $('#id_detalle_obs').val(detalle);

            
        })


        $('#id_peso_max_peticion').text('{% trans "Peso máximo combinado de imágenes: " %}' + (Math.round((peso_max_data / 1024 / 1024) * 10) / 10) + ' MB');

        


        if(envioIncluido){
            envioClienteSubtotal = 0;
            envioClienteImpuestos = 0;
            envioClienteTotal = 0;
        }else{
            envioClienteTotal = itemDatos.costoEnvio;
            envioClienteSubtotal = itemDatos.costoEnvio / ( 1 + (itemDatos.impuestosTallerPrct/100));
            envioClienteImpuestos = envioClienteTotal - envioClienteSubtotal;
        }



        $('#id_precio_final').val(simbolo_moneda + ' ' + (precio_final_orden + envioClienteTotal));
        if(precio_recalculado_total_op && ( precio_recalculado_total_op !== 'None')){
            if(decimales === 'True'){
                $('#id_precio').val(simbolo_moneda + ' ' + (precio_recalculado_total_op + envioClienteTotal).toFixed(2));
            } else {
                $('#id_precio').val(simbolo_moneda + ' ' + Math.round(precio_recalculado_total_op + envioClienteTotal));
            }
        }else{
             if(decimales === 'True'){
                $('#id_precio').val(simbolo_moneda + ' ' + (precio_final_orden + envioClienteTotal).toFixed(2));
            } else {
                $('#id_precio').val(simbolo_moneda + ' ' + Math.round(precio_final_orden + envioClienteTotal));
            }
        }

        if(total_taller_recalculado){

            if(isNaN(total_taller_recalculado)){
                total_taller = total_taller;
            }else{

                total_taller = total_taller_recalculado
            }
        }
        llenarDetallesCostos();

        

        

        tipo_usuario = parseInt('{{ user.tipo_usuario_id }}');

        

        $('#frmEnvioMaterial').hide();
        $('#frmRecibeMaterial').hide();
        $('#frmAnulaOrden').hide();
        $('#frmEnvioProducto').hide();
        $('#frmDevolucionProducto').hide();
        $('#frmVentaOrden').hide();
        $('#frmFinalizarTrabajo').hide();
        $('#frmFinalizarSinVenta').hide()
        $('#frmRecibeProducto').hide();
        $('#frmCargarDocumentosTa').hide();
        $('#frmCargarDocumentosOp').hide();
        $('#id_div_frmEnvioMaterial').hide();
        $('#id_div_frmRecibeMaterial').hide();
        $('#id_div_frmAnulaOrden').hide();
        $('#id_div_frmFinalizarTrabajo').hide();
        $('#id_div_frmEnvioProducto').hide();
        $('#id_div_frmDevolucionProducto').hide();
        $('#id_div_frmVentaOrden').hide();
        $('#id_div_frmFinalizarSinVenta').hide();
        $('#id_div_frmRecibeProducto').hide();
        $('#id_div_frmCargarDocumentosOp').hide();
        $('#id_div_frmCargarDocumentosTa').hide();

        $('#fec_mat_enviado').hide();
        $('#fec_proceso').hide();
        $('#fec_trab_fin').hide();
        $('#fec_prod_enviado').hide();
        $('#fec_prod_recibido').hide();
        $('#fec_finalizado').hide();
        $('#lbl_costo_envio').hide();
        $('#id_costo_envio').hide();
        $('#id_costo_envio').val(0);


        envio_incluido = '{{ orden.tienda.sociedad.grupo_empresarial.envio_incluido }}';
        if(envio_incluido === 'True' || envio_incluido === "False"){
            $('#lbl_costo_envio').show();
            $('#id_costo_envio').show();
            $('#id_costo_envio').val(0);
        }

        var estado = parseInt('{{ orden.estado_id }}');
        if(estado === 13 || estado === 14 || estado === 15 || estado === 16 || estado === 17 || estado === 19 || estado === 18 || estado === 11){
            // material enviado
            $('#txt_mat_enviado').removeClass("text-secondary");
            $('#txt_mat_enviado').addClass("text-success");
            $('#li_mat_enviado').removeClass("timeline-icon-secondary");
            $('#li_mat_enviado').addClass("timeline-icon-success");
            $('#fec_mat_enviado').show();
        }
        if(estado === 14 || estado === 15 || estado === 16 || estado === 17 || estado === 19 || estado === 18 || estado === 11){
            // en proceso
            $('#txt_proceso').removeClass("text-secondary");
            $('#txt_proceso').addClass("text-success");
            $('#li_proceso').removeClass("timeline-icon-secondary");
            $('#li_proceso').addClass("timeline-icon-success");
            $('#fec_proceso').show();
        }
        if(estado === 15 || estado === 16 || estado === 17 || estado === 19 || estado === 18 || estado === 11){
            // trab finalizado
            $('#txt_trab_finalizado').removeClass("text-secondary");
            $('#txt_trab_finalizado').addClass("text-success");
            $('#li_trab_fin').removeClass("timeline-icon-secondary");
            $('#li_trab_fin').addClass("timeline-icon-success");
            $('#fec_trab_fin').show();
            
        }
        if(estado === 16 || estado === 17 || estado === 19 || estado === 18 || estado === 11){
            // prod enviado
            $('#txt_prod_enviado').removeClass("text-secondary");
            $('#txt_prod_enviado').addClass("text-success");
            $('#li_prod_enviado').removeClass("timeline-icon-secondary");
            $('#li_prod_enviado').addClass("timeline-icon-success");
            $('#fec_prod_enviado').show();
            
            
        }
        if(estado === 17 || estado === 19){
            // prod recibido
            $('#txt_prod_recibido').removeClass("text-secondary");
            $('#txt_prod_recibido').addClass("text-success");
            $('#li_prod_recibido').removeClass("timeline-icon-secondary");
            $('#li_prod_recibido').addClass("timeline-icon-success");
            $('#fec_prod_recibido').show();
            
        }
        if(estado === 19){
            // finalizado
            $('#txt_finalizado').removeClass("text-secondary");
            $('#txt_finalizado').addClass("text-success");
            $('#li_finalizado').removeClass("timeline-icon-secondary");
            $('#li_finalizado').addClass("timeline-icon-success");
            $('#fec_finalizado').show();
            
        }

    });

    function devolverProd(){
        $('#modal_select_obs').modal('show');
        $('#id_observacion').val(0);
        $('#div_observacion').hide();

    }

    function mostrarFormulario(formulario, boton1, boton2){
        $('#'+boton1).hide();
        $('#'+boton2).hide();
        $('#btnCancelar').hide();
        $('#frmEnvioMaterial').hide();
        $('#frmRecibeMaterial').hide();
        $('#frmAnulaOrden').hide();
        $('#frmEnvioProducto').hide();
        $('#frmDevolucionProducto').hide();
        $('#frmVentaOrden').hide();
        $('#frmFinalizarTrabajo').hide();
        $('#frmFinalizarSinVenta').hide();
        $('#frmRecibeProducto').hide();
        $('#id_div_frmEnvioMaterial').hide();
        $('#id_div_frmRecibeMaterial').hide();
        $('#id_div_frmAnulaOrden').hide();
        $('#id_div_frmFinalizarTrabajo').hide();
        $('#id_div_frmEnvioProducto').hide();
        $('#id_div_frmDevolucionProducto').hide();
        $('#id_div_frmVentaOrden').hide();
        $('#id_div_frmFinalizarSinVenta').hide();
        $('#id_div_frmRecibeProducto').hide();
        $('#id_div_'+formulario).show();
        $('#'+formulario).show();
    }

    function validarArchivo(elemento){
        var peso_max_img = parseInt('{{ peso_max_arc.valor }}');
        var ext_perm_img = eval('{{ ext_perm_arc.valor }}');
        peso_max_img = (peso_max_img * 1024) * 1024;
        var fileInput = document.getElementById(elemento);

        var filePath = fileInput.value;
        if(!ext_perm_img.exec(filePath)){

            mensaje('{% trans "Archivo con extensión no válida" %}', 'red');
            fileInput.value='';
            return false;
        } else {
            file = fileInput.files[0];
            if(file.size > peso_max_img){
                mensaje('{% trans "Archivo supera el tamaño máximo permitido" %}', 'red');
                fileInput.value='';
                return false;
            } else {
                return true;
            }
        }
    }


    function cargarTooltip(){

        var tools = {{tooltips|safe}};
        label = $('#comprobante_env').text();
        for(var i =0; i < tools.length; i++){
            if(label === tools[i].campo){
                agg = $('#id_comp_envio_ta');
                $(agg).attr('data-toggle', false);
                $(agg).attr('data-toggle', 'tooltip').prop('title', tools[i].texto).tooltip('show');
                $(agg).addClass('hover')
            }
        }
        var url = '';

    }


    
    

    $('#id_comp_envio_op').on('change', function(){
        elemento = 'id_comp_envio_op';
        validarArchivo(elemento);
    });

    $('#id_comp_envio_ta').on('change', function(){
        elemento = 'id_comp_envio_ta';
        validarArchivo(elemento);
    });

    $('#id_factura_vta').on('change', function(){
        elemento = 'id_factura_vta';
        validarArchivo(elemento);
    });

    $('#id_factura_taller').on('change', function(){
        elemento = 'id_factura_taller';
        validarArchivo(elemento);
    });

    $('#id_cta_por_pagar').on('change', function(){
        elemento = 'id_cta_por_pagar';
        validarArchivo(elemento);
    });

    $('#id_orden_compra').on('change', function(){
        elemento = 'id_orden_compra';
        validarArchivo(elemento);
    });

    function envioMaterial(){

        if($('#id_gramos_enviados').val() === ''){
            mensaje('{% trans "Ingrese los gramos enviados" %}', 'red');
            return;
        }

        form = document.getElementById('frmEnvioMaterial');
        var data = new FormData(form);
        data.append('gramos_enviados', $('#id_gramos_enviados').val());

        documentos_obligatorios = '{{ user.pais.documentos_obligatorios }}';
        
        if(documentos_obligatorios === 'True'){
            if($('#id_comp_envio_op').val() === ''){
                mensaje('{% trans "Por favor cargar un comprobante" %}', 'red');
                return;
            }
        }

        if($('#id_comp_envio_op').val() !== ''){
            data.append('comp_envio_op', $('#id_comp_envio_op')[0].files[0]);
        }

        orden_id = '{{ orden.id_orden }}';

        var url_modificada = "{% url 'trn:envio_material' 0 %}";
        url = url_modificada.replace(/0/, orden_id);

        $.ajax({
        url: url,
        data: data,
        type: "POST",
        contentType: false,
        processData: false,
        beforeSend: function(){
            $('.loader').show();
        },
        complete: function(){
            $('.loader').hide();
        },
        success: function(response){
            let url = "{% url 'trn:ordenes_lista' %}";
            location.replace(url);
        },
        error: function(jqXHR, textStatus, errorThrow){
            console.log(textStatus, errorThrow);
            mensaje(errorThrow, 'red');
        }
        });
    }

    function recibeMaterial(){

        if($('#id_gramos_recibidos').val() === ''){
            mensaje('{% trans "Ingrese los gramos recibidos" %}', 'red');
            return;
        }

        var gramos_enviados = '{{ orden.gramos_enviados }}';
        gramos_enviados = gramos_enviados.replace(/,/, '.');
        gramos_enviados = parseFloat(gramos_enviados);

        var gramos_recibidos = $('#id_gramos_recibidos').val();
        gramos_recibidos = gramos_recibidos.replace(/,/, '.');
        gramos_recibidos = parseFloat(gramos_recibidos);
        dif_gramos = gramos_recibidos - gramos_enviados;
        dif_gramos = Math.round(dif_gramos * 100) / 100;

        if(dif_gramos > 0){
            mensaje = '{% trans "Existe una diferencia de " %}' + '<strong style="color: #5cb85c;">' + dif_gramos + '</strong>' +'{% trans " gramos" %}'; 
        } else {
            if(dif_gramos === 0){
                mensaje = '{% trans "Existe una diferencia de " %}' + '<strong style="color: #0275d8;">' + dif_gramos + '</strong>' +'{% trans " gramos" %}';
            } else {
                mensaje = '{% trans "Existe una diferencia de " %}' + '<strong style="color: #d9534f;">' + dif_gramos + '</strong>' +'{% trans " gramos" %}';
            }
        }

        $.confirm({
            title: '{% trans "Comparación de peso de material" %}',
            content: mensaje,
            theme: 'material',
            type: 'orange',
            buttons: {
                confirm: {
                    text: '{% trans "Continuar" %}',
                    action: function() {
                        form = document.getElementById('frmRecibeMaterial');
                        var data = new FormData(form);
                        data.append('gramos_recibidos', $('#id_gramos_recibidos').val());

                        orden_id = '{{ orden.id_orden }}';

                        var url_modificada = "{% url 'trn:recibe_material' 0 %}";
                        url = url_modificada.replace(/0/, orden_id);

                        $.ajax({
                            url: url,
                            data: data,
                            type: "POST",
                            contentType: false,
                            processData: false,
                            beforeSend: function(){
                                $('.loader').show();
                            },
                            complete: function(){
                                $('.loader').hide();
                            },
                            success: function(response){
                                // console.log('correcto');
                                location.reload(true);
                            },
                            error: function(jqXHR, textStatus, errorThrow){
                                console.log(textStatus, errorThrow);
                                mensaje(errorThrow, 'red');
                            }
                        });
                    }
                },
                cancel: {
                    text: '{% trans "Cancelar" %}',
                    action: function() {
                        return;
                    }
                },
            }
        });
    }

    function anularOrden(){

        if($('#id_anular_observacion').val() === ''){
            mensaje('{% trans "Ingrese una observación" %}', 'red');
            return;
        }

        form = document.getElementById('frmAnulaOrden');
        var data = new FormData(form);
        data.append('obs_recepcion_mat', $('#id_anular_observacion').val());

        orden_id = '{{ orden.id_orden }}';

        var url_modificada = "{% url 'trn:anular_orden' 0 %}";
        url = url_modificada.replace(/0/, orden_id);

        $.ajax({
        url: url,
        data: data,
        type: "POST",
        contentType: false,
        processData: false,
        beforeSend: function(){
            $('.loader').show();
        },
        complete: function(){
            $('.loader').hide();
        },
        success: function(response){
            console.log('correcto');
            location.reload(true);
        },
        error: function(jqXHR, textStatus, errorThrow){
            console.log(textStatus, errorThrow);
            mensaje(errorThrow, 'red');
        }
        });
    }

    function iniciarTrabajo(estado){

        orden_id = '{{ orden.id_orden }}';
        var token = '{{ csrf_token }}';
        dato = {
        'estado': estado
        }
        var datos = JSON.stringify(dato);

        var url_modificada = "{% url 'trn:ordenes_detalle' 0 %}";
        url = url_modificada.replace(/0/, orden_id);

        $.ajax({
            headers: {
                "X-CSRFToken": token
            },
            url: url,
            type: "POST",
            data: datos,
            beforeSend: function(){
                $('.loader').show();
            },
            complete: function(){
                $('.loader').hide();
            },
            success: function(response) {
                location.reload(true);
                window.location = template;
            },
            error: function(jqXHR, textStatus, errorThrow) {
                console.log(textStatus, errorThrow);
                alert("error: " + errorThrow); // pendiente mostrar error de clave duplicada
            }
        });
    }

    function ValidarFinalizarTrabajo(){

        if(cargarImagenes){
            contador = 0;
            peso_acumulado_img = 0;
            $('input.inputimage').each(function (){
                if($(this).val() === ''){
                    contador += 1;
                } else {
                    peso_acumulado_img += this.files[0].size;
                    if(peso_acumulado_img > peso_max_data){
                        mensaje('{% trans "La suma de tamaños de las imágenes supera el máximo permitido, por favor elimine al menos una imagen" %}', 'orange');
                        return false;
                    }
                }
            });
            if(contador > 0){
                mensaje('{% trans "Falta al menos una imagen por cargar" %}', 'orange');
                return false;
            } else {
                finalizarTrabajo();
            }
        } else {
            finalizarTrabajo();
        }
    }

    function finalizarTrabajo(){
        
        
        if($('#id_peso_final').val() === ''){
            mensaje('{% trans "Ingrese peso final" %}', 'red');
            return;
        }else{
            peso = $('#id_peso_final').val();

        }

        if(recalcular){
            
            itemDatos.gramos = peso;
            itemDatos.pesoSolicitado = peso;
            // console.log(itemDatos)

            transaccionCalculada = calcularValoresTransaccion(itemDatos);
            llenarDetallesCostos();
        }

        form = document.getElementById('frmFinalizarTrabajo');
        var datos = new FormData(form);
        datos.append('peso_final', $('#id_peso_final').val());
        if(recalcular){
            // alert(prct_util_fabricacion_taller)
            datos.append('costo_gramo_base_taller', transaccionCalculada.materiaPrimaTallerCostoUnitario);
            datos.append('precio_gramo_base_taller', transaccionCalculada.materiaPrimaTallerPrecioUnitario);
            datos.append('prct_utilidad_base_taller', transaccionCalculada.materiaPrimaTallerUtilidadPrct);
            datos.append('costo_base_total_ta', transaccionCalculada.materiaPrimaTallerCostoTotal);
            datos.append('utilidad_base_taller', transaccionCalculada.materiaPrimaTallerUtilidad);
            datos.append('precio_base_total_ta', transaccionCalculada.materiaPrimaTallerPrecioTotal);

            datos.append('costo_fabricacion_unitario', itemDatos.manoObraCostoUnitario);
            datos.append('costo_total_fabricacion_ta', transaccionCalculada.manoObraCostoTotal);
            datos.append('prct_util_fabricacion_taller', itemDatos.manoObraUtilidadPrct);

            datos.append('utilidad_fabricacion_taller', transaccionCalculada.manoObraUtilidad);
            datos.append('precio_fabricacion_unitario', itemDatos.manoObraPrecioUnitario);
            datos.append('precio_fabricacion_total_ta', transaccionCalculada.manoObraPrecioTotal);

            datos.append('costo_piedras_basicas', costo_piedras_basicas);
            datos.append('costo_color_unitario', transaccionCalculada.colorCostoAdicionalUnitario);
            datos.append('costo_color_total', transaccionCalculada.colorCostoAdicionalTotal);
            datos.append('total_rubros', transaccionCalculada.rubrosCostoTotal);

            datos.append('subtotal_taller', transaccionCalculada.subtotalTaller);
            datos.append('prct_impuestos_taller', transaccionCalculada.impuestosTallerPrct);
            datos.append('impuestos_taller', transaccionCalculada.impuestosTaller.toFixed(2));
            datos.append('total_taller', transaccionCalculada.totalTaller.toFixed(2));

            datos.append('costo_gramo_base_op', transaccionCalculada.materiaPrimaTiendaCostoUnitario);
            datos.append('precio_gramo_base_op', transaccionCalculada.materiaPrimaTiendaPrecioUnitario);
            datos.append('costo_base_total_op', transaccionCalculada.materiaPrimaTiendaCostoTotal);
            datos.append('prct_utilidad_base_op', transaccionCalculada.materiaPrimaTiendaUtilidadPrct);
            datos.append('utilidad_base_op', transaccionCalculada.materiaPrimaTiendaUtilidad);

            datos.append('precio_base_total_op', transaccionCalculada.materiaPrimaTiendaPrecioTotal);
            datos.append('prct_util_fabricacion_op', transaccionCalculada.fabricacionTiendaUtilidadPrct);

            datos.append('precio_unitario_op', transaccionCalculada.precioFinalTiendaUnitario);
            datos.append('utilidad_fabricacion_op', transaccionCalculada.fabricacionTiendaUtilidad);
            datos.append('precio_fabricacion_total_op', transaccionCalculada.precioFinalTiendaTotal);
            datos.append('subtotal_op', transaccionCalculada.subtotalTransaccion);
            datos.append('impuestos_op', (transaccionCalculada.impuestosTienda).toFixed(2));

            datos.append('total_fabricacion_op', transaccionCalculada.precioFinalTiendaTotal);
            datos.append('subtotal_orden', (transaccionCalculada.subtotalTransaccion).toFixed(2));
            datos.append('prct_impuestos_joyeria', itemDatos.impuestosTiendaPrct);
            datos.append('impuestos_orden', transaccionCalculada.impuestosTienda);
            datos.append('precio_sistema', transaccionCalculada.precioSistema.toFixed(2));
            datos.append('descuento', descuento);
            datos.append('precio_final_orden', transaccionCalculada.precioFinalTransaccion);
            
        }
        // console.log(datos)
        // for (var [key, value] of datos.entries()) { 
        //     console.log(key, value);
        // }

        orden_id = '{{ orden.id_orden }}';

        var url_modificada = "{% url 'trn:finalizar_trabajo' 0 %}";
        url = url_modificada.replace(/0/, orden_id);

        $.ajax({
            url: url,
            data: datos,
            type: "POST",
            contentType: false,
            processData: false,
            beforeSend: function(){
                $('.loader').show();
            },
            complete: function(){
                $('.loader').hide();
            },
            success: function(response){
                location.reload(true);
            },
            error: function(jqXHR, textStatus, errorThrow){
                console.log(textStatus, errorThrow);
                mensaje(errorThrow, 'red');
            }
        });
    }

    function enviarProducto(){  

        form = document.getElementById('frmEnvioProducto');
        var data = new FormData(form);
        costo_envi = $('#id_costo_envio').val();

        documentos_obligatorios = '{{ user.pais.documentos_obligatorios }}';

        if(documentos_obligatorios === 'True'){
            if($('#id_comp_envio_ta').val() === ''){
                mensaje('{% trans "Por favor cargar imagen de comprobante" %}', 'red');
                return;
            }
        }

        if($('#id_comp_envio_ta').val() !== ''){
            data.append('comp_envio_ta', $('#id_comp_envio_ta')[0].files[0]);
        }

        if(costo_envi === ''){
            mensaje('{% trans "Ingrese costo de envío" %}', 'red');
            return;
        }

        data.append('costo_envio', $('#id_costo_envio').val());

        orden_id = '{{ orden.id_orden }}';

        var url_modificada = "{% url 'trn:enviar_producto' 0 %}";
        url = url_modificada.replace(/0/, orden_id);

        $.ajax({
        url: url,
        data: data,
        type: "POST",
        contentType: false,
        processData: false,
        beforeSend: function(){
            $('.loader').show();
        },
        complete: function(){
            $('.loader').hide();
        },
        success: function(response){
            let url = "{% url 'trn:ordenes_lista' %}";
            location.replace(url);
        },
        error: function(jqXHR, textStatus, errorThrow){
            console.log(textStatus, errorThrow);
            mensaje(errorThrow, 'red');
        }
        });
    }

    function recibirProducto(){

        orden_id = '{{ orden.id_orden }}';
        var token = '{{ csrf_token }}';

        form = document.getElementById('frmRecibeProducto');
        var data = new FormData(form);
        data.append('estado', 17);

        var url_modificada = "{% url 'trn:recibir_producto' 0 %}";
        url = url_modificada.replace(/0/, orden_id);

        $.confirm({
            title: '{% trans "Aviso" %}',
            content: '{% trans "Se notificará al cliente que ya puede retirar su pedido" %}',
            theme: 'material',
            type: 'orange',
            buttons: {
                confirm: {
                    text: '{% trans "Continuar" %}',
                    action: function() {
                        $.ajax({
                            headers: {
                                "X-CSRFToken": token
                            },
                            url: url,
                            type: "POST",
                            data: data,
                            contentType: false,
                            processData: false,
                            beforeSend: function(){
                                $('.loader').show();
                            },
                            complete: function(){
                                $('.loader').hide();
                            },
                            success: function(response) {
                                location.reload(true);
                                window.location = template;
                            },
                            error: function(jqXHR, textStatus, errorThrow) {
                                console.log(textStatus, errorThrow);
                                alert("error: " + errorThrow); // pendiente mostrar error de clave duplicada
                            }
                        });
                    }
                },
                cancel: {
                    text: '{% trans "Cancelar" %}',
                    action: function() {
                        return;
                    }
                },
            }
        });
    }

    function cargarDocumentosTa(){

        orden_id = '{{ orden.id_orden }}';
        var token = '{{ csrf_token }}';

        form = document.getElementById('frmCargarDocumentosTa');
        var data = new FormData(form);
        cargarFacturaTaller = '{{ user.grupo_empresarial.factura_taller }}';
        if(cargarFacturaTaller === 'True'){
            if($('#id_factura_taller').val() === ''){
                mensaje('{% trans "Por favor cargar una factura" %}', 'red');
                return;
            }
        }

        if($('#id_factura_taller').val() !== ''){
            data.append('factura_taller', $('#id_factura_taller')[0].files[0]);
        }

        var url_modificada = "{% url 'trn:cargar_doc_taller' 0 %}";
        url = url_modificada.replace(/0/, orden_id);

        $.ajax({
            headers: {
                "X-CSRFToken": token
            },
            url: url,
            type: "POST",
            data: data,
            contentType: false,
            processData: false,
            beforeSend: function(){
                $('.loader').show();
            },
            complete: function(){
                $('.loader').hide();
            },
            success: function(response) {
                location.reload(true);
                window.location = template;
            },
            error: function(jqXHR, textStatus, errorThrow) {
                console.log(textStatus, errorThrow);
                alert("error: " + errorThrow); // pendiente mostrar error de clave duplicada
            }
        });
    }

    function cargarDocumentosOp(){
        cargar_cta_por_pagar = '{{ user.grupo_empresarial.cta_por_pagar }}';
        cargar_orden_compra = '{{ user.grupo_empresarial.orden_compra }}';

        form = document.getElementById('frmCargarDocumentosOp');
        var data = new FormData(form);

        if(cargar_orden_compra === 'True'){
            if($('#id_orden_compra').val() === ''){
                mensaje('{% trans "Por favor cargar orden de compra" %}', 'red');
                return;
            } else {
                data.append('orden_compra', $('#id_orden_compra')[0].files[0]);
            }
        }

        if(cargar_cta_por_pagar === 'True'){
            if($('#id_cta_por_pagar').val() === ''){
                mensaje('{% trans "Por favor cargar cuenta por pagar" %}', 'red');
                return;
            } else {
                data.append('cta_por_pagar', $('#id_cta_por_pagar')[0].files[0]);
            }
        }

        orden_id = '{{ orden.id_orden }}';

        var url_modificada = "{% url 'trn:cargar_doc_ope' 0 %}";
        url = url_modificada.replace(/0/, orden_id);

        $.ajax({
            url: url,
            data: data,
            type: "POST",
            contentType: false,
            processData: false,
            beforeSend: function(){
                $('.loader').show();
            },
            complete: function(){
                $('.loader').hide();
            },
            success: function(response){
                console.log('correcto');
                location.reload(true);
            },
            error: function(jqXHR, textStatus, errorThrow){
                console.log(textStatus, errorThrow);
                mensaje(errorThrow, 'red');
            }
        });
    }

    function devolverProducto(){
        var token = '{{ csrf_token }}';
        
        var observacion_ta = $('#id_detalle_adicional').val();

        var select_obs = $('option:selected', '#id_observacion').val();

        if(select_obs === '0' && '{{user.tipo_usuario.descripcion}}' === 'USUARIO OPERACIONES'){
            mensaje('{% trans "Por favor Seleccione una observación" %}', 'red');
            return;
        }

        if(observacion_ta === '' && ('{{user.tipo_usuario.descripcion}}' === 'USUARIO OPERACIONES')){
            mensaje('{% trans "Por favor agregue una descripcion breve." %}', 'red');
            return;
        }


        if (observacion_ta[0] === '.'){
           toastr.error('{% trans "No se permite un punto como observacion adicional." %}', '{% trans Atencion %}');
            return; 
        }

        if (observacion_ta[0] === ' '){
            toastr.error('{% trans "No se permite espacios como primer caracter." %}', '{% trans Atencion %}');
            return;
        }

        longitud_observacion = observacion_ta.length;
        if(longitud_observacion <  20){
            toastr.error('{% trans "Longitud minima. 20 caracteres" %}, longitud de texto '+longitud_observacion, '{% trans "Atencion" %}');
            return;   
        }


        var data = {
            'id_observacion': select_obs,
            'observacion_adicional': observacion_ta
        }
        data = JSON.stringify(data);
        console.log(data)


        orden_id = '{{ orden.id_orden }}';

        var url_modificada = "{% url 'trn:devolver_producto' 0 %}";
        url = url_modificada.replace(/0/, orden_id);
        console.log(url)
        $.ajax({
            headers: {
                        "X-CSRFToken": token
                    },
            type: "POST",
            url: url,
            data: data,
            beforeSend: function(){
                $('.loader').show();
            },
            complete: function(){
                $('.loader').hide();
            },
            success: function (response) {
                location.reload(true);
                cerrar_modal();
                var url = "{% url 'trn:ordenes_lista' %}";
                location.replace(url);

            },
            error: function (jqXHR, textStatus, errorThrow) {
                console.log(textStatus, errorThrow);
                mensaje(errorThrow, 'red');
            }
        });
    }

    function finalizarOrden(){

        form = document.getElementById('frmVentaOrden');
        var data = new FormData(form);

        orden_id = '{{ orden.id_orden }}';

        documentos_obligatorios = '{{ user.pais.documentos_obligatorios }}';
        if(documentos_obligatorios === 'True'){
            if($('#id_factura_vta').val() === ''){
                mensaje('{% trans "Por favor cargar una factura" %}', 'red');
                return;
            }
        }

        if($('#id_factura_vta').val() !== ''){
            data.append('factura_vta', $('#id_factura_vta')[0].files[0]);
        }

        data.append('obs_venta', $('#id_obs_venta').val());

        var url = "{% url 'trn:finalizar_orden' 0 %}";
        url = url.replace(/0/, orden_id);

        $.ajax({
            url: url,
            data: data,
            type: "POST",
            contentType: false,
            processData: false,
            beforeSend: function(){
                $('.loader').show();
            },
            complete: function(){
                $('.loader').hide();
            },
            success: function(response){
                // enviarCorreoCliente();
                let url = "{% url 'trn:ordenes_lista' %}";
                location.replace(url);
            },
            error: function(jqXHR, textStatus, errorThrow){
                console.log(textStatus, errorThrow);
                mensaje(errorThrow, 'red');
            }
        });
    }

    function finalizarSinVenta(){

        if($('#id_sin_venta_observacion').val() === ''){
            mensaje('{% trans "Por favor ingrese una observación" %}', 'red');
            return;
        }

        form = document.getElementById('frmFinalizarSinVenta');
        var data = new FormData(form);
        data.append('obs_venta', $('#id_sin_venta_observacion').val());

        orden_id = '{{ orden.id_orden }}';

        var url_modificada = "{% url 'trn:finalizar_sin_venta' 0 %}";
        url = url_modificada.replace(/0/, orden_id);

        $.ajax({
            url: url,
            data: data,
            type: "POST",
            contentType: false,
            processData: false,
            beforeSend: function(){
                $('.loader').show();
            },
            complete: function(){
                $('.loader').hide();
            },
            success: function(response){
                let url = "{% url 'trn:ordenes_lista' %}";
                location.replace(url);
            },
            error: function(jqXHR, textStatus, errorThrow){
                console.log(textStatus, errorThrow);
                mensaje(errorThrow, 'red');
            }
        });
    }

    function enviarCorreoCliente(){

        form = document.getElementById('frmVentaOrden');
        var data = new FormData(form);
        data.append('factura_vta', $('#id_factura_vta')[0].files[0]);
        data.append('obs_venta', $('#id_obs_venta').val());

        var url = "{% url 'trn:correo_cliente' %}";

        $.ajax({
        url: url,
        data: data,
        type: "GET",
        contentType: false,
        processData: false,
        beforeSend: function(){
            $('.loader').show();
        },
        complete: function(){
            $('.loader').hide();
        },
        success: function(response){
            console.log('correo enviado');
            location.reload(true);
        },
        error: function(jqXHR, textStatus, errorThrow){
            console.log(textStatus, errorThrow);
            mensaje(errorThrow, 'red');
        }
        });

    }

    $('img.img-fluid').on('click', function(){
        // src = $(this).attr('src');
        // carrusel = $('#carousel-example-generic');
        // console.log(carrusel);
        // Swal.fire({
        //     html:
        //         carrusel,
        //     showClass: {
        //         popup: 'animated fadein'
        //     },
        //     confirmButtonColor: '#3085d6',
        //     confirmButtonText: '<i class="bx bx-check"></i>'
        // });
        mostrarModal();
    });

    function mostrarModal(){
        $('#exampleModalCenter').modal('show');
    }

    function ocultarModal(){
        $('#exampleModalCenter').modal('hide');
    }

    // Carga de imágenes al finalizar trabajo de fabricación
    function agregarImg(){
        var url_img_tmp = "{% static 'base/img/icons/nofoto2.png' %}";
        var div = '<div id="elemento_" class="col-md-3 col-12 col-sm-12 item_img"><img id="id_img_tmp_" name="imagentmp" src="'+url_img_tmp+'" width="150px" height="150px" class="imgtmp center img-fluid pointer" width="100%"><input onchange="seleccionarImagen(elemento_,id_img_tmp_)" type="file" name="imagen" id="id_imagen_" class="inputimage center pointer" width="150px"><button onclick="borrardivImg(elemento_)" class="btn btn-icon btn-danger rounded-circle button_img" type="button" data-repeater-delete style="position: absolute; top: 10px; left: 10px;"><i class="bx bx-x"></i></button></div>';
        $('#id_img_lista').append(div);
        nombrarElementosImg();
    }

    function borrardivImg(div){
        $(div).remove();
        nombrarElementosImg();
    }

    function nombrarElementosImg(){
        cantidad_img = parseInt('{{ cantidad_max_img.valor }}');
        num = 0;
        $('div.item_img').each(function (){
            num++;
            $(this).removeAttr('id');
            $(this).attr('id', 'elemento_'+num);
            imgs = $(this).find('.imgtmp');
            img = imgs[0];
            $(img).removeAttr('id');
            $(img).attr('id', 'id_img_tmp_'+num);
            inputs = $(this).find('.inputimage');
            input = inputs[0];
            $(input).removeAttr('id');
            $(input).attr('id', 'id_imagen_'+num);
            $(input).removeAttr('onchange');
            var img_tmp = "'" + "id_img_tmp_" + num + "'";
            var img_input = "'" + "id_imagen_" + num + "'";
            $(input).attr('onchange', 'seleccionarImagen('+img_tmp+','+img_input+')');
            buttons = $(this).find('.button_img');
            button = buttons[0];
            $(button).removeAttr('id');
            $(button).attr('id', 'boton'+num);
            $(button).removeAttr('onclick');
            $(button).attr('onclick', 'borrardivImg(elemento_'+num+')');
        });
        if(num >= cantidad_img){
            $('#btnAgregarImagen').hide();
        } else {
            $('#btnAgregarImagen').show();
        }
    }

    function validarImagen(elemento){
        var peso_max_img = parseInt('{{ peso_max_img.valor }}');
        var ext_perm_img = eval('{{ ext_perm_img.valor }}');
        peso_max_img = (peso_max_img * 1024) * 1024;
        var fileInput = document.getElementById(elemento);
        var filePath = fileInput.value;
        if(!ext_perm_img.exec(filePath)){
            mensaje('{% trans "Archivo debe ser una imagen" %}', 'red');
            fileInput.value='';
            return false;
        } else {
            file = fileInput.files[0];
            if(file.size > peso_max_img){
                mensaje('{% trans "Archivo supera el tamaño máximo permitido" %}', 'red');
                fileInput.value='';
                return false;
            } else {
                return true;
            }
        }
    }

    function seleccionarImagen(tmp, elemento){

        var preview = $('#'+tmp);
        var input = $('#'+elemento);
        var file    = input.prop('files')[0];
        var reader  = new FileReader();

        reader.onloadend = function () {
            preview.attr('src', reader.result);
        }

        if (file) {
            if(validarImagen(elemento)){
                reader.readAsDataURL(file);
            } else {
                preview.attr('src', "{% static 'base/img/icons/nofoto2.png' %}");
            }
        } else {
            preview.attr('src', "{% static 'base/img/icons/nofoto2.png' %}");
        }
    }

    function llenarDetallesCostos(){
        let costo_envio = parseFloat('{{orden.costo_envio}}'.replace(/,/, '.'));

        var digitos;
        if(decimales === 'True'){
            digitos = 2;
        } else {
            digitos = 0;
        }

        let envioSubtotal = redondear(costo_envio / (1 + (prct_impuestos_taller/100)));
        let impuestosEnvio = (costo_envio - envioSubtotal )


        // valores del taller
        $('#val_mat_prima_ta').text(simbolo_moneda + ' ' + (costo_gramo_base_taller).toFixed(digitos));

        $('#val_man_obra_ta').text(simbolo_moneda + ' ' + (precio_fabricacion_total_ta).toFixed(digitos));
        $('#val_rubros_ta').text(simbolo_moneda + ' ' + (costo_total_rubros).toFixed(digitos));
        $('#val_adicionales').text(simbolo_moneda + ' ' + (total_adicional_piedrasicionals + total_piedra).toFixed(digitos));
        $('#val_piedra_adicional').text(simbolo_moneda + ' ' + costo_piedras_basicas.toFixed(digitos));
        $('#costo_env').text(simbolo_moneda + ' ' + envioSubtotal.toFixed(digitos));



        // $('#val_color_ta').text(simbolo_moneda + ' ' + ().toFixed(digitos));
        $('#val_subtotal_ta').text(simbolo_moneda + ' ' + (subtotal_taller + envioSubtotal).toFixed(digitos) );
        $('#val_impuestos_ta').text(simbolo_moneda + ' ' + (impuestos_taller + impuestosEnvio).toFixed(digitos));
        $('#val_total_ta').text(simbolo_moneda + ' ' + (total_taller + costo_envio).toFixed(digitos));

        // $('#val_subtotal_ta').text(simbolo_moneda + ' ' + (subtotal_taller ).toFixed(digitos) );
        // $('#val_impuestos_ta').text(simbolo_moneda + ' ' + (impuestos_taller).toFixed(digitos));
        // // $('#val_total_ta').text(simbolo_moneda + ' ' + (total_taller).toFixed(digitos));
        // $('#val_total_ta').text(simbolo_moneda + ' ' + (total_taller + costo_envio).toFixed(digitos));


        // valores de joyeria
        $('#val_mat_prima_op').text(simbolo_moneda + ' ' + (costo_base_total_op).toFixed(digitos));
        $('#val_util_fabricacion').text(simbolo_moneda + ' ' + (utilidad_base_op + utilidad_fabricacion_op).toFixed(digitos));
        // $('#val_util_adicionales').text(simbolo_moneda + ' ' + (transaccionCalculada.piedrasFinasTiendaUtilidad + transaccionCalculada.adicionalesTiendaUtilidad).toFixed(digitos));
        // $('#val_util_op').text(simbolo_moneda + ' ' + (transaccionCalculada.materiaPrimaTiendaUtilidad + transaccionCalculada.fabricacionTiendaUtilidad + transaccionCalculada.piedrasFinasTiendaUtilidad + transaccionCalculada.adicionalesTiendaUtilidad ).toFixed(digitos));
        // $('#val_color_op').text(simbolo_moneda + ' ' + transaccionCalculada.colorCostoAdicionalTotal.toFixed(digitos));
        $('#val_subtotal_op').text(simbolo_moneda + ' ' + (subtotal_orden + envioClienteSubtotal).toFixed(digitos) );
        $('#val_impuestos_op').text(simbolo_moneda + ' ' + (impuestos_orden  + envioClienteImpuestos).toFixed(digitos));
 
    }

    // Recalcular precio de orden al ingresar peso final de fabricación


    
    $('#id_peso_final').on('change', function(){
        if(recalcular){
            // origen = '{{orden.origen_material.descripcion}}'
            peso = $('#id_peso_final').val();
            itemDatos.gramos = parseFloat(peso);
            itemDatos.piedrasLista = [];
            itemDatos.adicionalesLista = [];
            adicionalesLista.forEach(adicional => {
                itemDatos.adicionalesLista.push(adicional);
            })
            piedraLista.forEach( piedra => {
                itemDatos.piedrasLista.push(piedra);
            })
            console.log(itemDatos)
            transaccionCalculada = calcularValoresTransaccion(itemDatos);
            llenarDetallesCostos();
        }
    })

    function CalcularDescuento() {
            precio_final_orden = precio_sistema - descuento;
            precio_final_orden = redondear(precio_final_orden);
            recalcularPrecioFinal(precio_final_orden);
    }

    function recalcularPrecioFinal(precioFinal){

        precio_final_solicitud = precioFinal;
        // Subtotales
        subtotal_solicitud = precio_final_solicitud / (1 + (prct_impuestos_joyeria/100));
        subtotal_solicitud = redondear(subtotal_solicitud);
        impuestos_solicitud = precio_final_solicitud - subtotal_solicitud;
        impuestos_solicitud = redondear(impuestos_solicitud);

        // Utilidad fabricación
        utilidad_fabricacion_op = subtotal_solicitud - total_taller - precio_base_total_op;
        utilidad_fabricacion_op = redondear(utilidad_fabricacion_op);
        precio_fabricacion_total_op = total_taller + utilidad_fabricacion_op;
        precio_fabricacion_total_op = redondear(precio_fabricacion_total_op);
        prct_util_fabricacion_op = ((precio_fabricacion_total_op - total_taller) / total_taller) * 100;

    }

    function redondear(valor){
        if(decimales === 'True'){
            return Math.round(valor * 100) / 100;
        } else {
            return Math.round(valor);
        }
    }

    function aprobarPago(){

        orden_id = '{{ orden.id_orden }}';
        var token = '{{ csrf_token }}';

        var url_modificada = "{% url 'trn:orden_aprobacion_pago' 0 %}";
        url = url_modificada.replace(/0/, orden_id);
        $.confirm({
            title: '{% trans "Aprobar pago" %}',
            content: '{% trans "¿Confirmar aprobación de pago?. Esta acción no se puede deshacer" %}',
            theme: 'material',
            type: 'orange',
            buttons: {
                confirm: {
                    text: '{% trans "Confirmar" %}',
                    action: function() {
                        $.ajax({
                            headers: {
                                "X-CSRFToken": token
                            },
                            url: url,
                            data: {},
                            type: "POST",
                            contentType: false,
                            processData: false,
                            success: function(response){
                                location.reload(true);
                    
                            },
                            error: function(jqXHR, textStatus, errorThrow){
                                console.log(textStatus, errorThrow);
                                mensaje(errorThrow, 'red');
                            }
                        });
                    }
                },
                cancel: {
                    text: '{% trans "Cancelar" %}',
                    action: function() {
                        return;
                    }
                },
            }
        });
    }

</script>
{% endblock %}