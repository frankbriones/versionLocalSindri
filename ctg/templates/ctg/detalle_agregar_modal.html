{% load i18n %}
<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h4 class="modal-title">{% trans "Agregar detalle" %}</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <i class="bx bx-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <form method="POST" class="form">
                {% csrf_token %}
                <div class="form-body">
                    <div class="row">
                        {% if item.categoria.unidad_medida.descripcion == 'TALLA' %}
                        <div class="col-md-6 col-12">
                            <div class="form-label-group">
                                <select name="talla_min" id="id_talla_min" class="form-control">
                                    {% for talla in tallas %}
                                    <option value="{{ talla.talla }}">{{ talla }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" hidden>
                                <label
                                    for="id_talla_min">{% trans "Talla mínima" %}</label>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-label-group">
                                <select name="talla_max" id="id_talla_max" class="form-control">
                                    {% for talla in tallas %}
                                    <option value="{{ talla.talla }}">{{ talla }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" hidden>
                                <label
                                    for="id_talla_max">{% trans "Talla máxima" %}</label>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-md-6 col-12">
                            <div class="form-label-group">
                                <input id="id_medida" name="medida" type="number" step="0.01" min="0.01" class="form-control">
                                <label for="city-column">{% trans "Medida" %}</label>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-label-group">
                                <input id="id_unidad_medida" name="unidad_medida" value="{{ item.categoria.unidad_medida }}" type="text" disabled class="form-control">
                                <label for="city-column">{% trans "Unidad de medida" %}</label>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-6 col-12">
                            <div class="form-label-group">
                                {{ form.peso_minimo }}
                                <label for="city-column">{% trans "Peso mínimo" %}</label>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-label-group">
                                {{ form.peso_maximo }}
                                <label for="city-column">{% trans "Peso máximo" %}</label>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-label-group">
                                {{ form.cantidad_piedras }}
                                <label for="city-column">{% trans "Cantidad de piedras" %}</label>
                            </div>
                        </div>
                        <div class="col-md-6 col-12">
                            <div class="form-label-group">
                                {{ form.costo_piedras }}
                                <label for="city-column">{% trans "Costo piedras" %}</label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-light-secondary" data-dismiss="modal">
                <i class="bx bx-x d-block d-sm-none"></i>
                <span class="d-none d-sm-block">{% trans "Cancelar" %}</span>
            </button>
            <button type="button" id="btnGuardar" name="aceptar" class="btn btn-primary ml-1">
                <i class="bx bx-check d-block d-sm-none"></i>
                <span class="d-none d-sm-block">{% trans "Guardar" %}</span>
            </button>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){

    var token = '{{ csrf_token }}';
    var cantidad_piedras = '{{ item.cantidad_piedras }}';
    cantidad_piedras = cantidad_piedras.replace(/,/, '.');
    cantidad_piedras = parseFloat(cantidad_piedras);
    var costo_piedras = '{{ item.costo_piedras }}';
    costo_piedras = costo_piedras.replace(/,/, '.');
    costo_piedras = parseFloat(costo_piedras);
    $('#id_costo_piedras').val(costo_piedras);
    $('#id_cantidad_piedras').val(cantidad_piedras);

    $("#btnGuardar").click(function(e){
        e.preventDefault();

        var item_id = '{{ item.id_item }}';
        unidad_medida = '{{ item.categoria.unidad_medida }}';
        unidad_medida_id = '{{ item.categoria.unidad_medida.id_unidad }}';

        var url_modificada = "{% url 'ctg:detalles_agregar' 0 %}";
        var template = url_modificada.replace(/0/, item_id);

        talla_min = $('#id_talla_min').val();
        talla_max = $('#id_talla_max').val();
        medida = parseFloat($('#id_medida').val());
        peso_minimo = $('#id_peso_minimo').val();
        peso_maximo = $('#id_peso_maximo').val();
        cantidad_piedras = $('#id_cantidad_piedras').val();
        costo_piedras = $('#id_costo_piedras').val();
        
        if( peso_minimo === '' || peso_maximo === '' || cantidad_piedras === '' || costo_piedras === ''){
            mensaje('{% trans "Favor completar todos los campos" %}', 'red');
            return;
        }

        if(unidad_medida === 'TALLA'){
            if(parseFloat(talla_min) > parseFloat(talla_max)){
                mensaje('{% trans "Talla mínima superior a la máxima" %}', 'red');
                return;
            } else {
                var data = {
                    "talla_min": talla_min,
                    "talla_max": talla_max,
                    "peso_minimo": peso_minimo,
                    "peso_maximo": peso_maximo,
                    "cantidad_piedras": cantidad_piedras,
                    "costo_piedras": costo_piedras,
                    "tipo": 1
                };
            }
        } else {
            if(medida === 0){
                mensaje('{% trans "Medida no puede ser 0" %}', 'red');
                return;
            } else {
                var data = {
                    "medida": medida,
                    "peso_minimo": peso_minimo,
                    "peso_maximo": peso_maximo,
                    "cantidad_piedras": cantidad_piedras,
                    "costo_piedras": costo_piedras,
                    "tipo": 2
                };
            }
        }

        data = JSON.stringify(data);
        $.ajax({
            headers: {
                "X-CSRFToken": token
            },
            type: "POST",
            url: template,
            data: data,
            success: function(response){
                if(response === 'duplicado'){
                    mensaje('{% trans "Ya existen detalles con las medidas ingresadas" %}', 'red')
                } else {
                    location.reload(true);
                    cerrar_modal();
                }
            },
            error: function(jqXHR, textStatus, errorThrow){
            console.log(textStatus, errorThrow);
            mensaje(errorThrow,'red');
            cerrar_modal();
            }
        });
    });
});
</script>